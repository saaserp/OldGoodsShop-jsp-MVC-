/*! search-suggest 2014-02-18 */
KISSY.add("tbc/search-suggest/1.1.7/mods/menu",function(a){var b=a.all,c=function(d){var e=this;e.opts=a.mix(c.defs,d),e.$wrap=b(e.opts.wrap),e.$menu=b(e.opts.menu),e.locs=[],e.rNow=null,e.tOut=null,e.init()};return c.defs={wrap:"",menu:"",rows:"",dealy:300,handler:null,tolerance:0},c.prototype.getOffset=function(){var a=this,b=a.opts,c=a.$menu,d=c.offset();a.menuOffset=d,a.upperRight={x:d.left+c.outerWidth(),y:d.top-b.tolerance},a.lowerRight={x:d.left+c.outerWidth(),y:d.top+c.outerHeight()+b.tolerance}},c.prototype.bindEvent=function(){var a,c,d,e=this,f=e.opts,g=e.locs,h=e.rNow,i=e.tOut,j=null,k=function(i){function k(a,b){return(b.y-a.y)/(b.x-a.x)}var l=!!b(i).one(f.cls);e.getOffset(),a=e.menuOffset,c=e.upperRight,d=e.lowerRight;var m=g[g.length-1],n=g[0];if(!h||!m)return 0;if(n.x<a.left||n.x>d.x||n.y<a.top||n.y>d.y)return 0;if(j&&m.x==j.x&&m.y==j.y)return 0;var o=k(m,c),p=k(m,d),q=k(n,c),r=k(n,d);return l&&q>o&&p>r?(j=m,f.dealy):(j=null,0)},l=function(a){h!=a&&(f.handler.enterHandler(a),h=a)},m=function(a,b){e.isDelay=b?!0:!1;var c=k(b);c?i=setTimeout(function(){m(e.currentTarget,e.currentTarget)},c):(e.isDelay=!1,l(a))},n=function(a){g.push({x:a.pageX,y:a.pageY}),g.length>3&&g.shift()},o=function(){h=null,f.handler.leaveHandler()},p=function(){e.isDelay=!1,h=null,i&&clearTimeout(i)},q=function(a){if(e.currentTarget=a.currentTarget,!e.isDelay){i&&clearTimeout(i);var c=a.relatedTarget,d=b(c).parent(f.rows);m(a.currentTarget,d)}};e.$wrap.on("mousemove",n).on("mouseleave",o),e.$menu.on("mouseleave",p).delegate("mouseenter",f.rows,q)},c.prototype.init=function(){this.getOffset(),this.bindEvent()},c},{requires:["node"]}),KISSY.add("tbc/search-suggest/1.1.7/plugin/cloud",function(S,Base,DOM,Node,Event,Cookie,Menu){function Cloud(a){Cloud.superclass.constructor.call(this,a||{})}var $=S.all,suggest,Utils,Stat;return S.extend(Cloud,Base,{pluginInitializer:function(a){var b,c,d=this,e=a.comboBox;d.isNotFirstRender=[],d.count=0,suggest=a,Utils=d.Utils,Stat=d.Stat,d.set("caller",a),d.initKeyEvent(),e.on("beforeShow",function(){if(d.isShowFirstItem){var a=e.get("menu"),b=a.get("children");a.set("highlightedItem",b[0]),d._showCloud(b[0].get("el")[0])}d.setCloudHeight()}),a.on("afterCollapsedChange",function(e){e.newVal||(a.detach("afterCollapsedChange",arguments.callee),d.mouseArr=[],c=a.get("menu"),b=c.get("el"),b.addClass("search-cloud-menu"),d.initMenu||(S.one(".search-menu")&&(d.initMenu=!0,d.menu=new Menu({wrap:".search-menu",menu:".search-contentbox,.search-menu-content",rows:".search-menuitem",cls:".search-wrap-cloud",tolerance:500,handler:{enterHandler:function(a){d._showCloud(a),d.setCloudHeight()},leaveHandler:function(a){d._hideCloud(a)}}})),c.on("afterHighlightedItemChange",function(){d.setCloudHeight()}),d.initMouseEvent(b)))})},initMouseEvent:function(a){return a?(a.delegate("click",".cloud-list a",function(a){var b=a.currentTarget,c=b.getAttribute("href");c&&(c=suggest.urlEncode(c),b.setAttribute("href",c))}),void 0):!1},setCloudHeight:function(){var a=suggest.get("menu").get("el"),b=S.one(".cloud-footer");if(b){if(cloudBox=b.one(".cloud-box"),cloudBox.css("height","auto"),a.css("height","auto"),cloudBox){var c=a.height(),d=cloudBox.height();d>c?a.height(d-1):(a.css("height","auto"),cloudBox.css("height","100%"))}}else a.css("height","auto")},_hideCloud:function(){$(".cloud-footer").hide(),$(".search-menu-item-hover").removeClass("search-menu-item-hover")},_showCloud:function(a){var b,c,d,e=this,f=$(".search-wrap-cloud",a),g=S.one(".cloud-footer");$(".search-menu-item-hover").removeClass("search-menu-item-hover"),$(a).addClass("search-menu-item-hover"),e.lastItemIndex&&(c=S.one("#J_CloudList"+e.lastItemIndex),c&&c.hide(),g&&g.hide()),f.length&&(b=f.one("div").attr("data-index"),e.lastItemIndex=b,c=S.one("#J_CloudList"+b),d=c.attr("data-align"),e.set("align",!("true"!==d)),c.show(),g&&g.show(),e.setPadding($(a),c))},_sendStat:function(){var a=(suggest.getPlugin("stat"),"f_stats_show=magic:1"),b=suggest.get("sugConfig").sourceUrl,c="";b&&b.match(/bucketid=\w+/)&&(c=b.match(/bucketid=(\w+)/)[1],a+=";bts:"+c),Stat&&Stat.send(a,!0)},getPadding:function(a,b){var c=32,d=S.one(".search-menu"),e=d.offset().top,f=a.offset().top,g=f-e,h=d.height(),i=b.height(),j=g-c,k=h-i-j-10;return j>0?k>=0?j:j-=39*Math.round(-k/39):void 0},initKeyEvent:function(){var a=this,b=suggest.comboBox,c=Event.KeyCodes||Node.KeyCode;b.on("beforeKeyDown",function(d){var e=this.get("menu");if(e.get){var f,g,h,i,j=d.event,k=e.get("highlightedItem"),l=e.get("children"),m=l.length;if(0===m)return void 0;switch(j.keyCode){case c.ENTER:var n=a.isShowMagic(),o=a.isShowItem(),p=n||o;return p&&(j.halt(),!n&&o&&S.UA.ie>=10?k.fire("click"):p.click()),!1;case c.UP:case c.DOWN:var q,r;j.keyCode===c.UP?(r=m-1,q=-1):(r=0,q=1),a.isTriggerArrowKey=!0,k?(f=S.indexOf(k,l),g=(f+q+m)%m):g=r;var s=S.one(".cloud-link-wrap-hover");return s&&s.removeClass("cloud-link-wrap-hover"),0===f&&-1===q||f===m-1&&1===q?(a._hideCloud(),e.set("highlightedItem",null),b._stopNotify=1,suggest.get("input").val(b._savedInputValue||b._savedValue),!1):(h=e._getNextEnabledHighlighted(g,q),e.set("highlightedItem",h),a._showCloud(h.get("el")[0]),b._stopNotify=1,i=h.get("textContent"),b.setValueFromAutocomplete?b.setValueFromAutocomplete(i):(b._stopNotify=1,suggest.get("input").val(i)),b.fire("beforeSetInputValue",{event:j}),!1);case c.HOME:case c.END:return h=j.keyCode===c.END?e._getNextEnabledHighlighted(m-1,-1):e._getNextEnabledHighlighted(0,1),e.set("highlightedItem",h),a._showCloud(h.get("el")[0]),b.setValueFromAutocomplete?b.setValueFromAutocomplete(h.get("textContent")):(b._stopNotify=1,suggest.get("input").val(h.get("textContent"))),!1;default:a.directionEvent(j)}}})},isShowMagic:function(){var a,b,c,d=S.all(".J_cloud-handle");return d.each(function(b){"none"!==DOM.css(b,"display")&&(a=b)}),a?(b=DOM.query(".cloud-link-wrap-hover")[0],b&&(c="a"===b.tagName.toLowerCase()?b:DOM.query("a",b)[0]),c):void 0},isShowItem:function(){var a=this;return a.isTriggerArrowKey&&DOM.get(".search-menu-item-hover")},directionEvent:function(a){var b,c,d,e,f,g,h=this;switch(a.keyCode){case 39:case 37:if(g=suggest.get("menu"),b=g.get("activeItem")||g.get("highlightedItem"),!b)return!0;if(c=b.get("el").one(".item-wrapper"),!c)return!0;if(d=c.attr("data-index"),!d)return!0;if(e=S.one("#J_CloudList"+d),!e)return!0;f=h.getHighLightItem(e,!!(a.keyCode-37)),f.node&&f.node.addClass("cloud-link-wrap-hover"),f.last&&f.last.removeClass("cloud-link-wrap-hover")}},getHighLightItem:function(a,b){var c=a.one(".cloud-link-wrap-hover"),d=b?"next":"prev";return c?{node:c[d](),last:c}:{node:a.one(".cloud-link").parent(),last:null}},setPadding:function(a,b){var c=this,d=b.one(".inner-wrap"),e=this.getPadding(a,d),f=c.get("align");f&&e&&d.css("paddingTop",e)},checkRender:function(a){var b,c=this,d=a.comboBox,e=a.query,f=d.get("dataSource"),g=f.extraData[e],h=a.resultArr;return b=""!==e&&g?{extra:g,query:e,results:h}:!1,c.extraData=g,c.isShowFirstItem=!1,b},isAutoShow:function(a){return!!(S.isArray(a)&&a.length>0&&(a[0].list||a[0].tag))},renderPlugin:function(){var a=this,b=a.checkRender(suggest);if(!b)return!1;var c,d,e,f,g,h,i,j,k="",l=b.extra,m=b.results,n=b.query;a.isFirstShow=!1,c=S.clone(l.magic);for(var o=a.isAutoShow(suggest.resultArr),p=0,q=m.length-1;q>=p;p++){d=m[p];for(var r in c){if(g=d.content,e=g.match(/data-index='(\w+)'/),f=g.match(/data-key='([\S\s]+?)'/),!e||!e[1])break;e=e[1]-0,f&&f[1]&&(f=f[1]),h=c[r],e===h.index-0&&(j=a._renderHTML({result:d,data:h,query:n,index:e,key:f,auto:o,type:h.type||"tag"}),j&&(k+=j),1===e&&j&&(i=!0))}}var s={tmpl:'<div class="cloud-box">'+k+"</div>",type:"cloud"};if(o&&i?(s.css={display:"block"},a.isShowFirstItem=!0):a.isShowFirstItem=!1,S.UA.ie<7){var t=suggest.resultArr.length;s.css={height:26*t}}suggest.__footer=s,suggest._addExtraEvent(),a.isTriggerArrowKey=!1},retTmplRepeatCfg:function(a){var b=a.match(/{#(\w+)}([\s\S]+?){\/\w+}/);return S.isArray(b)&&b[2]?{key:b[1],tmpl:b[2],source:b[0]}:!1},doTmplRepeat:function(a){var b,c=this,d=a.data,e=a.tmplCfg,f=e.tmpl,g=a.repeatCfg,h=g.tmpl,i=e.length,j={},k="";i<d.length&&(d=d.splice(0,i)),e.sort&&c.sort(d);for(var l in d){var m=d[l];j.xindex=l,S.isObject(m)?(j=S.merge(j,m),j.xthis=""):j.xthis=m,b=c.substitute(h,j),k+=b}return f.replace(g.source,k)},substitute:function(tmpl,data,flag){var _tmpData,ret,_tmpStr;return ret=tmpl.replace(/{(\w+)([^}]+)?}/g,function($0,$1,$2){if(_tmpData=data[$1]||$0,_tmpStr=_tmpData,$2)try{return S.isString(_tmpData)&&(_tmpStr='"'+_tmpStr+'"'),eval(_tmpStr+$2)}catch(e){S.log("eval error")}return flag&&S.isString(_tmpData)&&_tmpData.indexOf("{")>-1?"":_tmpData})},_renderHTML:function(a){var b,c,d,e,f=this,g={},h=a.result,i=a.data,j=a.query,k=a.index,l=f.extraData,m=a.type,n=a.key,o=a.auto&&1===k?"style='display:block'":"";if(l&&l.event&&1===k)c=f.get("event-tmpl"),d=f.get("event-param");else{if(!m)return S.log("\u9b54\u76d2\u7c7b\u578b\u4e0d\u5b58\u5728!"),o="",!1;if(e=f.get(m),!e)return S.log("\u63a5\u53e3\u8fd4\u56de\u7684\u7c7b\u578b"+m+"\u4e0d\u5b58\u5728\u5bf9\u5e94\u7684\u6a21\u677f"),o="",!1;c=e.tmpl,d=f.get("param")}var p=f.retTmplRepeatCfg(c);b=h.content,h.content="<div class='search-wrap-cloud' data-key='"+n+"'>"+b+"</div>",g.tagTitle=b.replace(/<(\s|\S)+?>/g,""),g.param=d?"&"+d:"",g.query=j,g.index=k,i.count&&i.count<=3&&(g.ishidden="hidden"),p?(c=f.doTmplRepeat({data:i.data,repeatCfg:p,tmplCfg:e}),g=S.merge(g,i)):i.data&&(g=S.merge(g,i.data)),g.autoAttr=o;var q=f.substitute(c,g,!0);return q},sort:function(a){Array.prototype.sort.call(a,function(){return Math.random()>.5?-1:1})}},{ATTRS:{pluginId:{value:"cloud"},limit:{value:3,setter:function(a){return S.isNumber(a)?a:void 0}},tag:{value:{tmpl:'<div id="J_CloudList{index}" data-align="true" class="J_cloud-handle cloud-list" {autoAttr} ><div class="inner-wrap"><h3>{tagTitle}</h3><ul>{#list}<li><a target="_self" href="http://s.taobao.com/search?q={tagTitle} {xthis}&wq={query}&source=suggest&suggest=magic_{index}_{xindex-0+1}&tag={xthis}{param}"  class="cloud-link"><span>{xthis}</span></a></li>{/list}</ul></div></div>',sort:!0,length:10}},navi:{value:{tmpl:'<div id="J_CloudList{index}" data-align="false" class="J_cloud-handle cloud-navi-list" {autoAttr}><div class="inner-wrap"><a class="cloud-img-wrap" href="http://{url}?source=suggest&suggest=navi_{index}_1" target="_self"><img src="http://gtms01.alicdn.com/tps/i1/{logo}_70x70.jpg" /></a><p>{title}</p><a class="cloud-btn-wrap" href="http://{url}?source=suggest&suggest=navi_{index}_1" target="_self"><span class="cloud-link">{button}</span><i>></i></a></div></div>'}},spu:{value:{tmpl:'<div id="J_CloudList{index}" data-align="false" class="J_cloud-handle cloud-spu-list" {autoAttr} ><div class="inner-wrap"><ul>{#list}<li><a class="cloud-img-wrap cloud-link" href="http://{url}&source=suggest&suggest=spu_{index}_{xindex-0+1}" target="_self"><img src="http://gtms01.alicdn.com/tps/i1/{pic}_50x50.jpg" /></a><a class="cloud-title" title="{title}" href="http://{url}&source=suggest&suggest=spu_{index}_{xindex-0+1}" target="_self"><span>{title}</span></a><p class="cloud-price {price-0===0?"cloud-hidden":""}">\u53c2\u8003\u4ef7:<b class="">\uffe5{price}</b><b class="noprice">\u6682\u65e0</b></p></li>{/list}</ul><p class="cloud-total {ishidden}"><span class="total">\u5171{count}\u6b3e\u4ea7\u54c1</span><a class="more" target="_self" href="http://{link}&source=suggest&suggest=spu_{index}_more">\u67e5\u770b\u5168\u90e8>></a></p></div></div>',length:3}},topbrand:{value:{tmpl:'<div id="J_CloudList{index}" data-align="false" class="J_cloud-handle cloud-topbrand-list" {autoAttr} ><div class="inner-wrap"><h3>\u201c{tagTitle.substr(0,11)}\u201d\u70ed\u95e8\u54c1\u724c</h3><ul>{#list}<li><a class="cloud-title cloud-link" href="http://{url}&source=suggest&suggest=brandlist_{index}_{xindex-0+1}" target="_self"><span><i class="cloud-top{xindex}">{xindex-0+1}</i>{title}</span></a></li>{/list}</ul></div></div>'}},align:{value:!0}}}),Cloud},{requires:["base","dom","node","event","cookie","tbc/search-suggest/1.1.7/mods/menu"]});