/*! webww 2014-08-11 */
KISSY.add("dragdrop",function(a){function b(a,b,c,d,e,f,g,h){return e>=c||f>=d||a>=g||b>=h?!1:!0}var c=a.Event,d=a.DOM,e=document,f=window,g={axis:0,region:!1,handle:!1,not:!1,revert:!1,snap:!1,scroll:!1,lock:!1,circular:!1,multi:!1,resize:!1,proxy:!1,delay:!1,resizefn:!1,cursor:!1},h=!1,i=function(b,c){var d=b,b=a.makeArray(a.query(b)),e=this,c=a.merge(g,c||{});a.each(b,function(a){e._init(a,c,d)})},j=function(a,b,c){return a>c?c:b>a?b:a},k=function(a){var b,c=d.css(a,"position");return"absolute"==c.toLowerCase()?b=[a.offsetLeft,a.offsetTop]:"relative"==c.toLowerCase()&&(b=[parseInt(d.css(a,"left"))||0,parseInt(d.css(a,"top"))||0]),b},l=function(b,c,d,e){if("left"===d.toLowerCase()){var f="offsetWidth",g=3,h=1;a.UA.ie&&(f="clientWidth")}else{var f="offsetHeight",g=0,h=2;a.UA.ie&&(f="clientHeight")}return num=c.region?j(parseInt(b.style[d])+e,c.region[g],c.region[h]):parseInt(b.style[d])+e},m=function(b,c,f){return num="left"===c.toLowerCase()?a.UA.ie?j(parseInt(b.style[c])+f,0,a.DOM.viewportWidth()-b.clientWidth-2):j(parseInt(b.style[c])+f,0,a.DOM.viewportWidth()-b.clientWidth-2-17):j(parseInt(b.style[c])+f,parseInt(b.style[c])-parseInt(d.offset(b).top)+(e.documentElement.scrollTop||e.body.scrollTop),99999)},n=function(b,c){if(a.isArray(c)){for(var e=0;e<c.length;e++)if(d.hasClass(b,c[e].substr(1)))return!0}else if(d.hasClass(b,c.substr(1)))return!0},o=function(a){var b=a.cloneNode(!0);return e.body.appendChild(b),b};setRegion=function(a,b){return b[0]=parseInt(d.css(a,"top"))-b[0],b[1]=parseInt(d.css(a,"left"))+b[1],b[2]=parseInt(d.css(a,"top"))+b[2],b[3]=parseInt(d.css(a,"left"))-b[3],b},a.augment(i,{_init:function(b,g,i){var j,p,q,r,s=!1,t=!1,u=this,v=!1,w=g.snap,x=[0,0];if(function(){var c=!1;if(a.isString(g.region)&&"scroll"!=g.region.toLowerCase()){var f=d.get(g.region);g.region=[d.offset(b).top-d.offset(f).top,d.offset(f).left+f.offsetWidth-(d.offset(b).left+b.offsetWidth),d.offset(f).top+f.offsetHeight-(d.offset(b).top+b.offsetHeight),d.offset(b).left-d.offset(f).left],c=!0}else a.isString(g.region)&&"scroll"==g.region.toLowerCase()?(g.region=[d.offset(b).top,e.documentElement.clientWidth-d.offset(b).left-b.offsetWidth,e.documentElement.clientHeight-d.offset(b).top-b.offsetHeight,d.offset(b).left],c=!0):4==g.region.length&&a.isArray(g.region);c&&setRegion(b,g.region),c=!1}(),g.circular)var y=k(b,g)[0]+g.circular+30,z=k(b,g)[1]+30;var A=function(a){g.islock&&(h=!0),g.not&&n(a.target,g.not)||(v=!0,x=k(b),q=a.clientX,r=a.clientY,!s&&g.proxy&&(t=b,s=o(b),b=s),d.css(b,"left",x[0]+"px"),d.css(b,"top",x[1]+"px"),g.cursor&&d.css(b,"cursor",g.cursor),u.onStartDrag&&u.onStartDrag(a,b,g))},B=function(h){if(v&&!u.isLock(g)){if(j=h.clientX-q,p=h.clientY-r,g.circular)angle=Math.atan2(h.clientX-y,h.clientY-z),d.css(b,"left",y+Math.sin(angle)*g.circular-30+"px"),d.css(b,"top",z+Math.cos(angle)*g.circular-30+"px");else if(g.snap)d.css(b,"left",parseInt(b.style.left)+Math.round(j/w[0])*w[0]+"px"),d.css(b,"top",parseInt(b.style.top)+Math.round(p/w[1])*w[1]+"px"),q+=Math.round(j/w[0])*w[0],r+=Math.round(p/w[1])*w[1];else if(g.resize){var k=parseInt(d.css(b,"width")),n=parseInt(d.css(b,"height"));g.resizefn[0]&&Math.max(20,k+j)>g.resizefn[0]&&(j>0&&h.clientX<=parseInt(d.offset(b).left)+k&&(j=0),d.css(b,"width",Math.max(20,k+j)+"px")),g.resizefn[1]&&Math.max(20,n+p)>g.resizefn[1]&&(p>0&&parseInt(h.clientY)<=parseInt(d.offset(b).top)+n-parseInt(e.documentElement.scrollTop||e.body.scrollTop)?p=0:d.css(b,"height",Math.max(20,n+p)+"px")),q=h.clientX,r=h.clientY}else if(g.scroll)"y"!=g.axis&&d.css(b,"left",m(b,"left",j)+"px"),"x"!=g.axis&&d.css(b,"top",m(b,"top",p)+"px"),q=h.clientX,r=h.clientY;else{if(g.multi&&d.hasClass(b,"ks-multi")){var o=a.makeArray(a.query(".ks-multi"));0==o&&(o=[b])}else o=[b];a.each(o,function(a){"y"!=g.axis&&d.css(a,"left",l(a,g,"left",j,x)+"px"),"x"!=g.axis&&d.css(a,"top",l(a,g,"top",p,x)+"px")}),q=h.clientX,r=h.clientY}a.UA.chrome&&c.on(document,"selectstart",function(a){a.halt()}),f.getSelection?f.getSelection().removeAllRanges():e.selection.empty(),u.onDrag&&u.onDrag(h,b,g,j,p,i)}},C=function(h){1==v&&(v=!1,c.remove(e,"mousemove",B),f.getSelection?f.getSelection().removeAllRanges():e.selection.empty(),s&&g.proxy&&(d.css(t,"left",parseInt(s.style.left)+"px"),d.css(t,"top",parseInt(s.style.top)+"px"),b=t,s.parentNode.removeChild(s),s=!1,t=!1),g.revert&&(d.css(b,"left",x[0]+"px"),d.css(b,"top",x[1]+"px")),g.cursor&&d.css(b,"cursor","default"),u.onEndDrag&&u.onEndDrag(h,b,g),a.UA.chrome&&c.remove(document,"selectstart"))},D=function(){d.hasClass(b,"ks-multi")?d.removeClass(b,"ks-multi"):d.addClass(b,"ks-multi")};c.add(a.get(g.handle,b)||b,"mousedown",function(a){A(a),c.add(e,"mousemove",B)}),c.add(e,"mouseup",C),g.multi&&c.add(b,"dblclick",D)},onStartDrag:null,onDrag:null,onEndDrag:null,isLock:function(){return h}}),a.Drag=i,a.Drag.intersectRect=b});var TDog=function(a){var b=a.DOM,c=TStart,d=window,e=d.g_config&&d.g_config.appId,f=(c.isOnline,c.Config.DOMAIN),g=function(){var a=location.hostname;return a=a.indexOf("tmall.com")>0?"webww.tmall.com":a.indexOf("tmall.net")>0?"webww.daily.tmall.net:8080":a.indexOf("taobao.net")>0?"webww.daily.taobao.net:8080":"webwangwang.taobao.com","http://"+a+"/"}(),h=function(){var a=location.hostname;return a=a.indexOf("tmall.com")>0?"webww.tmall.com":a.indexOf("tmall.net")>0?"webww.daily.tmall.net:8080":a.indexOf("taobao.net")>0?"webww.daily.taobao.net:8080":"get.webwangwang.taobao.com","http://"+a+"/"}(),i=".do",j="http://www.taobao.com/wangwang/2010_fp/buyer.php?tracelogww2010=webww",k="http://www.taobao.com/wangwang/2010_fp/seller.php?tracelogww2010=webww";return{version:"1.0",_MODS:{},add:function(a,b){return this._MODS[a]=b(TDog)},Config:{getTokenUrl:g+"gettoken"+i,loginUrl:g+"login"+i,getLoginResultUrl:g+"getloginresult"+i,startUrl:g+"start"+i,receiveUrl:g+"receive"+i,sendUrl:g+"send"+i,getUrl:g+"get"+i,notifyUrl:h+"connection.html?t=20110322",connectionURL:g+"buildconnection"+i,checkAutoLoginUrl:g+"usertag.do",getTalkUsers:g+"gettalkusers"+i,ackGetMessage:g+"ackgetmessage"+i,tbLoginUrl:"https://login."+f+"/member/login.jhtml?f=top",tmsAdUrl:"http://www.taobao.com/go/rgn/tdog/link-for-chat-window.php",tmsBulletinUrl:"http://www.taobao.com/go/rgn/webww/wangwang-bulletin.php",clearUrl:g+"clear.do",clearListUrl:g+"clear.do?act=2",setAutoLoginUrl:g+"usertag.do",TagKeyUrl:g+"tagkey.do",LIGHT_NICK:"wwlight",forceAutoLogin:!1,appId:e,X:"x",NOTIFY_STATUS:{logout:{key:0,value:-1},timeout:{key:1,value:-2},message:{key:2,value:-3},close:{key:3,value:-4},notMessage:{key:4,value:0}},downloadWangWangURLBuy:j,downloadWangWangURLSeller:k,DOMAIN:f,LOGIN_KEY:"login_key",hash:[9,6,7,19,15,22,2,26,18,24,21,25,16,13,25,12]},isReady:!1,init:function(c,d){function f(){l.init(),g.WebServer.init(),g.RecentList.init(),g.ChatDialog.init(),g.SysMessage.init(),g.SysPopup.init(),g.isReady=!0,g.EventCenter.fire(g.EVENTS.TDOG_READY)}a.log("\u5f00\u59cb\u521d\u59cb\u5316 Web \u65fa\u65fa");var g=this,h=g.Util,i=g.Config,j=g.Login,k=g.SysTips,l=g.DataManager,m=a.Cookie.get(i.X),n=a.get("#tstart");if(j.init(),g.host=c,g.hostEl=d,k.init(),g.StatusIcon.init(),g.EventCenter.init(),"tdog"===a.unparam(m).p||Light.addonIsOK()||!l.getNickName())return a.log("\u63a7\u4ef6\u5b89\u88c5\u6b63\u5e38\u6216\u6dd8\u5b9d\u672a\u767b\u5f55\uff0cWeb \u65fa\u65fa\u9000\u51fa\u521d\u59cb\u5316"),b.addClass(n,"tstart-tdog-disabled"),void 0;if(Light.addonIsOK())return a.log("\u63a7\u4ef6\u5b89\u88c5\u6b63\u5e38\uff0c\u5de5\u5177\u6761\u4e0a\u4e0d\u663e\u793a Web \u65fa\u65fa\uff0c\u9000\u51fa\u521d\u59cb\u5316"),b.addClass(n,"tstart-tdog-disabled"),void 0;if(Light.addonIsOK())return a.log("\u63a7\u4ef6\u5b89\u88c5\u6b63\u5e38\uff0c\u5de5\u5177\u6761\u4e0a\u4e0d\u663e\u793a Web \u65fa\u65fa\uff0c\u9000\u51fa\u521d\u59cb\u5316"),b.addClass(n,"tstart-tdog-disabled"),void 0;b.addClass(n,"tstart-tdog-enable");var o=location.search;if(o&&(o=o.substring(1))){var p=a.unparam(o),q=p[i.LIGHT_NICK];0===e&&(q=h.decode(p.touid||p.tid)),q&&(a.log("wwlight = "+q),h.hasSitePrefix(q)||(q="cntaobao"+q),Light.lightedUsers.push(q),i.forceAutoLogin=!0)}7===e&&n&&(n.style.zIndex=20001),f()},EVENTS:{CLICK_LIGHT_ICON:"clickLightIcon",CLICK_STATUS_ICON:"clickStatusIcon",LOGIN_START:"loginStart",LOGIN_SUCCESS:"loginSuccess",ERROR_LOGIN_FAILED:"errorLoginFailed",SHOW_RECENT_LIST:"showRecentList",SHOW_CHAT_DIALOG:"showChatDialog",SHOW_CHAT_MSG:"showChatMsg",RECEIVE_CHAT_MESSAGE:"receiveChatMessage",RECEIVE_SUBSCRIBE_MESSAGE:"receiveSystemMessage",RECEIVE_POPUP_MESSAGE:"receivePopupMessage",RECEIVE_LOGINOUT_SIGNAL:"receiveLoginoutSignal",UPDATE_USER_STATUS:"updateUserStatus",UPDATE_STATUS_ICON:"updateStatusIcon",ERROR_GET_CHAT_INFO:"errorGetChatInfo",UPDATE_CHAT_INFO:"updateChatInfo",SEND_MESSAGE:"sendMessage",ERROR_GET_MESSAGE:"errorGetMessage",UPDATE_LOCAL_STATUS:"updateLocalStatus",DAEMON_FIRE:"daemonFire",TDOG_READY:"tdogReady"},USER_STATUS:{1:["offline","\u79bb\u7ebf"],2:["free","\u5728\u7ebf"],3:["busy","\u5fd9\u788c\u4e2d"],4:["away","\u4e0d\u5728\u7535\u8111\u65c1"],5:["incall","\u63a5\u542c\u7535\u8bdd\u4e2d"],6:["outofdinner","\u5916\u51fa\u5c31\u9910"],7:["wait","\u7a0d\u5019"],8:["invisible",""],9:["offlinelogin",""],10:["unknown",""],11:["fakeonline",""],12:["mobileonline","\u624b\u673a\u5728\u7ebf"],13:["free","\u65fa\u4fe1\u5728\u7ebf"],14:["busy","\u8bf7\u52ff\u6253\u6270"]},ERROR_MESSAGE:{0:"",1:"\u8d26\u6237\u4e0d\u5b58\u5728\uff0c\u8bf7\u8f93\u5165\u6b63\u786e\u7684\u8d26\u6237\u540d\u3002",2:"\u60a8\u8f93\u5165\u7684\u8d26\u6237\u540d\u548c\u5bc6\u7801\u4e0d\u5339\u914d\uff0c\u8bf7\u91cd\u65b0\u8f93\u5165\u3002",3:'\u60a8\u7684\u5e10\u53f7\u4e0d\u80fd\u767b\u5f55\u7f51\u9875\u7248\u65fa\u65fa\uff0c\u8bf7\u4f7f\u7528\u963f\u91cc\u65fa\u65fa\u5ba2\u6237\u7aef\uff0c<a target="_blank" class="tstart-item-tips-on" href="'+k+'">\u70b9\u6b64\u4e0b\u8f7d\uff01</a>',4:"\u60a8\u7684\u8d26\u6237\u6743\u9650\u4e0d\u591f\u3002",5:"\u60a8\u767b\u5f55\u7684\u5e10\u53f7\u6570\u91cf\u5df2\u8d85\u8fc7\u6700\u5927\u6570\u91cf\u3002",6:'\u60a8\u662fE\u5ba2\u670d\u7528\u6237\uff0c\u53ea\u80fd\u4f7f\u7528\u963f\u91cc\u65fa\u65fa\uff0c<a target="_blank" class="tstart-item-tips-on" href="'+k+'">\u70b9\u6b64\u4e0b\u8f7d\uff01</a>',"-1":"\u7cfb\u7edf\u9519\u8bef\uff0c\u8bf7\u7a0d\u5019\u518d\u8bd5\u3002","-2":"\u5bf9\u65b9\u8d26\u53f7\u4e0d\u5b58\u5728\uff0c\u8bf7\u68c0\u67e5\u3002","-3":"\u8d26\u6237\u4e0d\u5b58\u5728\uff0c\u8bf7\u8f93\u5165\u6b63\u786e\u7684\u8d26\u6237\u540d\u3002","-4":"\u767b\u5f55\u5931\u8d25\uff0c\u8bf7\u91cd\u65b0\u767b\u5f55\u3002","-5":"\u767b\u5f55\u5931\u8d25\uff0c\u8bf7\u91cd\u65b0\u767b\u5f55\u3002","-6":"\u53d1\u9001\u6d88\u606f\u4e0d\u5141\u8bb8\u4e3a\u7a7a\u3002","-7":"\u60a8\u53d1\u9001\u7684\u6d88\u606f\u8fc7\u957f\uff0c\u8bf7\u4e0b\u8f7d\u652f\u6301\u53d1\u9001\u8d85\u957f\u4fe1\u606f\u7684\u963f\u91cc\u65fa\u65fa\u5ba2\u6237\u7aef\u3002","-8":"\u963f\u91cc\u65fa\u65fa\u6682\u65f6\u4e0d\u53ef\u7528\uff0c\u8bf7\u7a0d\u5019\u518d\u8bd5\u3002","-9":"\u8d26\u6237\u4e0d\u5b58\u5728\uff0c\u8bf7\u8f93\u5165\u6b63\u786e\u7684\u8d26\u6237\u540d\u3002","-10":"\u963f\u91cc\u65fa\u65fa\u6682\u65f6\u4e0d\u53ef\u7528\uff0c\u8bf7\u7a0d\u5019\u518d\u8bd5\u3002","-11":"\u7cfb\u7edf\u9519\u8bef\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5\u3002","-12":"\u963f\u91cc\u65fa\u65fa\u6682\u65f6\u4e0d\u53ef\u7528\uff0c\u8bf7\u7a0d\u5019\u518d\u8bd5\u3002","-14":"\u8bfb\u6d88\u606f\u51fa\u9519\uff0c\u8bf7\u91cd\u8bd5\u3002","-15":"\u963f\u91cc\u65fa\u65fa\u5ba2\u6237\u7aef\u5728\u7ebf\uff0c\u662f\u5426\u8e22\u6389\u963f\u91cc\u65fa\u65fa\u5ba2\u6237\u7aef\u3002","-16":"\u963f\u91cc\u65fa\u65fa\u5ba2\u6237\u7aef\u5728\u7ebf\uff0c\u662f\u5426\u8e22\u6389\u963f\u91cc\u65fa\u65fa\u5ba2\u6237\u7aef\u3002","-17":"\u767b\u5f55\u5931\u8d25\uff0c\u975e\u6cd5\u8bf7\u6c42\u3002","-100":"\u963f\u91cc\u65fa\u65fa\u5df2\u79bb\u7ebf\uff0c\u8bf7\u91cd\u65b0\u767b\u5f55\u3002","-101":"\u60a8\u8fd8\u6ca1\u6709\u767b\u5f55\uff0c\u8bf7\u767b\u5f55\u3002","-102":'\u60a8\u7684\u5e10\u53f7\u88ab\u7981\u6b62\u767b\u5f55WEB\u65fa\u65fa\uff0c\u8bf7\u4f7f\u7528\u963f\u91cc\u65fa\u65fa\u5ba2\u6237\u7aef\u767b\u5f55\uff08<a target="_blank" class="tstart-item-tips-on" href="'+j+'">\u70b9\u6b64\u4e0b\u8f7d\uff01</a>\uff09\u3002',"-1000":"\u83b7\u53d6\u4fe1\u606f\u5931\u8d25\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5\u3002","-1001":"\u83b7\u53d6\u4fe1\u606f\u5931\u8d25\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5\u3002","-40000":'\u8981\u652f\u6301\u8be5\u529f\u80fd\uff0c\u8bf7\u4e0b\u8f7d <a  target="_blank" href="'+j+'">\u963f\u91cc\u65fa\u65fa\u5ba2\u6237\u7aef</a>'},MESSAGE_TYPE:{OFFLINE:1,TALK:2,STATUS:3,LOGOUT:4,SYSTEM:5,SELF:6},MESSAGE_SUBTYPE:{TALK_MESSAGE:201,AUTO_BACK_TALK_MESSAGE:202,NEED_AUTH:204,FAIL_ACK:205,FILE_MESSAGE:206,PIC_MESSAGE:207,GRAFFITI:208,REMOTE_ASSIST:209,AV:210,FOLDER:211,ILLEGALITY:212,PEER_VERIFY:213,NO_HEARTBEAT:401,OTHER_LOGIN:402,SESSION_TIMEOUT:403,POPUP_MESSAGE:501,SUBSCRIBE_MESSAGE:502},UNSUPPORT_MSG:{204:"\u5bf9\u65b9\u9700\u8981\u9a8c\u8bc1\uff0c\u6682\u65f6\u65e0\u6cd5\u53d1\u9001\u3002",205:"\u53d1\u9001\u3010{content}\u3011\u6d88\u606f\u5931\u8d25\u3002",206:"\u5bf9\u65b9\u6b63\u5411\u60a8\u4f20\u6587\u4ef6\u3002",207:"\u5bf9\u65b9\u6b63\u5411\u60a8\u53d1\u56fe\u7247\u3002",208:"\u5bf9\u65b9\u6b63\u9080\u8bf7\u60a8\u6d82\u9e26\u3002",209:"\u5bf9\u65b9\u6b63\u9080\u8bf7\u60a8\u8fdc\u7a0b\u534f\u52a9\u3002",210:"\u5bf9\u65b9\u6b63\u9080\u8bf7\u60a8\u8bed\u97f3\u89c6\u9891\u3002",211:"\u5bf9\u65b9\u6b63\u5411\u60a8\u4f20\u6587\u4ef6\u5939\u3002",212:"\u60a8\u53d1\u9001\u7684\u6d88\u606f\u4e2d\u53ef\u80fd\u5305\u542b\u4e86\u6076\u610f\u7f51\u5740\u3001\u8fdd\u89c4\u5e7f\u544a\u53ca\u5176\u4ed6\u7c7b\u5173\u952e\u8bcd\uff0c\u8bf7\u505c\u6b62\u53d1\u9001\u7c7b\u4f3c\u7684\u6d88\u606f\uff01",213:"\u5bf9\u65b9\u9700\u8981\u9a8c\u8bc1\uff0c\u6682\u65f6\u65e0\u6cd5\u53d1\u9001\u3002"},SITES:{TAOBAO:"cntaobao",YAHOO:"chnyahoo",WANGWANG:"wangwnag",CNALICHN:"cnalichn",ENALIINT:"enaliint",CNALIMAM:"cnalimam",CNKOUBEI:"cnkoubei",HTYAHOO:"htyahooo",CNWUJING:"cnwujing",CHNAIGOU:"chnaigou"}}}(KISSY);TDog.add("Util",function(a){var b=KISSY,c=a.Config.DOMAIN;a.Util={detect:function(a,b){var c=+new Date,d=window[c]=new Image;d.src="http://log.mmstat.com/"+a+"?cache="+Math.floor(1e7*Math.random())+"&wwnick=cntaobao"+b,d.onload=d.onerror=function(){window[c]=null},d=null},contains:function(a,b){for(var c=a.length-1;c>=0;c--)if(a[c].sendTime==b.sendTime&&a[c].content==b.content)return!0;return!1},uniqueArray:function(a){for(var b=[],c=a.length,d=function(a,b){for(var c=0,d=a.length;d>c;c++)if(a[c]==b)return!0;return!1},e=0;c>e;e++)d(b,a[e])||b.push(a[e]);return b},css:function(a){var b=KISSY.DOM;KISSY.each(a,function(a){b.css(a[0],a[1],a[2])})},getRandom:function(a,b){return a+parseInt((b-a+1)*Math.random(),10)},genUniqueName:function(){for(var a=0,b="";10>a;a++)b+=String.fromCharCode(this.getRandom(97,122));return"_"+b+ +new Date},decode:function(a){if(!a)return"";var b=a;try{b=decodeURIComponent(a)}catch(c){}return b},SITES_REG:function(){var b=[];for(var c in a.SITES)b.push(a.SITES[c]);return new RegExp("^("+b.join("|")+")(.*)$","i")}(),hasSitePrefix:function(b){return a.Util.SITES_REG.test(b)},getUserName:function(b){if(!b)return"";var c=b,d=b.match(a.Util.SITES_REG);return d&&d[1]&&(c=b.substr(d[1].length)),c},substitute:function(a,b){return a.replace(/\{([^}]+)\}/g,function(a,c){return b[c]||""})},escapeHTML:function(a){var b=document.createElement("div"),c=document.createTextNode(a);return b.appendChild(c),b.innerHTML},isTaobao:function(){return"taobao.com"===c||"taobao.net"===c},formatDate:function(a){var b="";return b+=a.getFullYear()+"-",b+=a.getMonth()+1<10?"0"+(a.getMonth()+1)+"-":a.getMonth()+1+"-",b+=a.getDate()<10?"0"+a.getDate()+" ":a.getDate()+" ",b+=a.getHours()<10?"0"+a.getHours():a.getHours(),b+=a.getMinutes()<10?":0"+a.getMinutes():":"+a.getMinutes(),b+=a.getSeconds()<10?":0"+a.getSeconds():":"+a.getSeconds()},getTmsContent:function(b){if(b){var c=this,d=KISSY;d.each(b,function(b){var e=b;e.data&&d.isFunction(e.hasDate)&&e.hasDate(),d.later(function(){a.Util.getScript(e.link+"?callback="+e.callback+"&t="+ +new Date,{onSuccess:function(){d.isFunction(c.hasDate)&&e.success()},scope:c,charset:a.Config.charset||"gbk"})},0)})}},charToFace:function(){var a={"/:^_^":["\u5fae\u7b11","0"],"/:^$^":["\u5bb3\u7f9e","1"],"/:Q":["\u5410\u820c\u5934","2"],"/:815":["\u5077\u7b11","3"],"/:809":["\u7231\u6155","4"],"/:^O^":["\u5927\u7b11","5"],"/:081":["\u8df3\u821e","6"],"/:087":["\u98de\u543b","7"],"/:086":["\u5b89\u6170","8"],"/:H":["\u62b1\u62b1","9"],"/:012":["\u52a0\u6cb9","10"],"/:806":["\u80dc\u5229","11"],"/:b":["\u5f3a","12"],"/:^x^":["\u4eb2\u4eb2","13"],"/:814":["\u82b1\u75f4","14"],"/:^W^":["\u9732\u9f7f\u7b11","15"],"/:080":["\u67e5\u627e","16"],"/:066":["\u547c\u53eb","17"],"/:807":["\u7b97\u8d26","18"],"/:805":["\u8d22\u8ff7","19"],"/:071":["\u597d\u4e3b\u610f","20"],"/:072":["\u9b3c\u8138","21"],"/:065":["\u5929\u4f7f","22"],"/:804":["\u518d\u89c1","23"],"/:813":["\u6d41\u53e3\u6c34","24"],"/:818":["\u4eab\u53d7","25"],"/:015":["\u8272\u60c5\u72c2","26"],"/:084":["\u5446\u82e5\u6728\u9e21","27"],"/:801":["\u601d\u8003","28"],"/:811":["\u8ff7\u60d1","29"],"/:?":["\u7591\u95ee","30"],"/:077":["\u6ca1\u94b1\u4e86","31"],"/:083":["\u65e0\u804a","32"],"/:817":["\u6000\u7591","33"],"/:!":["\u5618","34"],"/:068":["\u5c0f\u6837","35"],"/:079":["\u6447\u5934","36"],"/:028":["\u611f\u5192","37"],"/:026":["\u5c34\u5c2c","38"],"/:007":["\u50bb\u7b11","39"],"/:816":["\u4e0d\u4f1a\u5427","40"],"/:&apos;&quot;&quot;":["\u65e0\u5948","41"],"/:&#39;&quot;&quot;":["\u65e0\u5948","41"],'/:\'""':["\u65e0\u5948","41"],"/:802":["\u6d41\u6c57","42"],"/:027":["\u51c4\u51c9","43"],"/:(Zz...)":["\u56f0\u4e86","44"],"/:*&amp;*":["\u6655","45"],"/:*&*":["\u6655","45"],"/:810":["\u5fe7\u4f24","46"],"/:&gt;_&lt;":["\u59d4\u5c48","47"],"/:>_<":["\u59d4\u5c48","47"],"/:018":["\u60b2\u6ce3","48"],"/:&gt;O&lt;":["\u5927\u54ed","49"],"/:>O<":["\u5927\u54ed","49"],"/:020":["\u75db\u54ed","50"],"/:044":["I\u670d\u4e86U","51"],"/:819":["\u5bf9\u4e0d\u8d77","52"],"/:085":["\u518d\u89c1","53"],"/:812":["\u76b1\u7709","54"],"/:&quot;":["\u597d\u7d2f","55"],'/:"':["\u597d\u7d2f","55"],"/:&gt;M&lt;":["\u751f\u75c5","56"],"/:>M<":["\u751f\u75c5","56"],"/:&gt;@&lt;":["\u5410","57"],"/:>@<":["\u5410","57"],"/:076":["\u80cc","58"],"/:069":["\u60ca\u8bb6","59"],"/:O=O":["\u8001\u5927","70"],"/:O":["\u60ca\u6115","60"],"/:067":["\u95ed\u5634","61"],"/:043":["\u6b20\u6241","62"],"/:P":["\u9119\u89c6\u4f60","63"],"/:808":["\u5927\u6012","64"],"/:&gt;W&lt;":["\u751f\u6c14","65"],"/:>W<":["\u751f\u6c14","65"],"/:073":["\u8d22\u795e","66"],"/:008":["\u5b66\u4e60\u96f7\u950b","67"],"/:803":["\u606d\u559c\u53d1\u8d22","68"],"/:074":["\u5c0f\u4e8c","69"],"/:036":["\u90aa\u6076","71"],"/:039":["\u5355\u6311","72"],"/:045":["CS","73"],"/:046":["\u9690\u5f62\u4eba","74"],"/:048":["\u70b8\u5f39","75"],"/:047":["\u60ca\u58f0\u5c16\u53eb","76"],"/:girl":["\u6f02\u4eaeMM","77"],"/:man":["\u5e05\u54e5","78"],"/:052":["\u62db\u8d22\u732b","79"],"/:(OK)":["\u6210\u4ea4","80"],"/:8*8":["\u9f13\u638c","81"],"/:)-(":["\u63e1\u624b","82"],"/:lip":["\u7ea2\u5507","83"],"/:-F":["\u73ab\u7470","84"],"/:-W":["\u6b8b\u82b1","85"],"/:Y":["\u7231\u5fc3","86"],"/:qp":["\u5fc3\u788e","87"],"/:$":["\u94b1","88"],"/:%":["\u8d2d\u7269","89"],"/:(&amp;)":["\u793c\u7269","90"],"/:(&)":["\u793c\u7269","90"],"/:@":["\u6536\u90ae\u4ef6","91"],"/:~B":["\u7535\u8bdd","92"],"/:U*U":["\u4e3e\u676f\u5e86\u795d","93"],"/:clock":["\u65f6\u949f","94"],"/:R":["\u7b49\u5f85","95"],"/:C":["\u5f88\u665a\u4e86","96"],"/:plane":["\u98de\u673a","97"],"/:075":["\u652f\u4ed8\u5b9d","98"]},b="";for(var c in a)b+="|"+c.substring(2);b=b.substring(1),b=b.replace(/([\^?()\.\*\$])/g,"\\$1");var d=new RegExp("\\\\T/:("+b+")\\\\T","g");return b=new RegExp("/:("+b+")","g"),function(c,e,f){if(c)if(e){var g=new RegExp("\\\\","g");c=c.replace(g,function(a){return a="\\\\"}),c=c.replace(b,function(b){return a[b]&&(b="\\T"+b+"\\T"),b})}else c=f?c.replace(d,function(b){var c=b.substring(2,b.length-2);return a[c]&&(b='<img src="http://a.tbcdn.cn/sys/wangwang/smiley/48x48/'+a[c][1]+'.gif" alt="'+a[c][0]+'" />'),b}):c.replace(b,function(b){return a[b]&&(b='<img src="http://a.tbcdn.cn/sys/wangwang/smiley/48x48/'+a[b][1]+'.gif" alt="'+a[b][0]+'" />'),b});return c}}(),faceToChar:function(a){var b=["/:^_^","/:^$^","/:Q","/:815","/:809","/:^O^","/:081","/:087","/:086","/:H","/:012","/:806","/:b","/:^x^","/:814","/:^W^","/:080","/:066","/:807","/:805","/:071","/:072","/:065","/:804","/:813","/:818","/:015","/:084","/:801","/:811","/:?","/:077","/:083","/:817","/:!","/:068","/:079","/:028","/:026","/:007","/:816",'/:\'""',"/:802","/:027","/:(Zz...)","/:*&*","/:810","/:>_<","/:018","/:>O<","/:020","/:044","/:819","/:085","/:812",'/:"',"/:>M<","/:>@<","/:076","/:069","/:O","/:067","/:043","/:P","/:808","/:>W<","/:073","/:008","/:803","/:074","/:O=O","/:036","/:039","/:045","/:046","/:048","/:047","/:girl","/:man","/:052","/:(OK)","/:8*8","/:)-(","/:lip","/:-F","/:-W","/:Y","/:qp","/:$","/:%","/:(&)","/:@","/:~B","/:U*U","/:clock","/:R","/:C","/:plane","/:075"],c=b[parseInt(a,10)];return c&&(c=c.replace("&gt;",">").replace("&lt;","<").replace("&amp;","&").replace("&apos;","'").replace("&quot;",'"').replace("&quot;",'"')),c},getScript:function(a,c,d){var e,f,g,h,i=window.document,j=i.getElementsByTagName("head")[0]||i.documentElement,k=i.createElement("script").readyState?function(a,b){var c=a.onreadystatechange;a.onreadystatechange=function(){var d=a.readyState;("loaded"===d||"complete"===d)&&(a.onreadystatechange=null,c&&c(),b.call(this))}}:function(a,b){a.addEventListener("load",b,!1)},l=/\.css(?:\?|$)/i,m=l.test(a),n=i.createElement(m?"link":"script"),o=c;return b.isPlainObject(o)&&(c=o.onSuccess,e=o.onFailure,h=o.onTimeout,f=o.timeout,d=o.charset),m?(n.href=a,n.rel="stylesheet"):(n.src=a,n.async=!0),d&&(n.charset=d),b.isFunction(c)&&(m?c.call(n):k(n,function(){g&&(g.cancel(),g=void 0),c.call(n),b.later(function(){j.removeChild(n),n=void 0},3e3)})),b.isFunction(h)&&(g=b.later(function(){g=void 0,h()},f||3e3)),j.insertBefore(n,j.firstChild),n},sendLog:function(a){var c="";b.UA.ie?c="ie"+b.UA.ie:b.UA.firefox?c="firefox"+b.UA.firefox:b.UA.chrome?c="chrome"+b.UA.chrome:b.UA.safari?c="safari"+b.UA.safari:b.UA.opera&&(c="opera"+b.UA.opera),b.later(function(){try{(new Image).src="http://log.mmstat.com/ww?cache="+(new Date).getTime()+"&browse="+c+"&"+a}catch(b){}},500)}}}),TDog.add("EventCenter",function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o=KISSY,p=a.EVENTS,q={init:function(){o.log("init EventCenter"),b=a.Util,c=a.Config,d=a.Login,h=a.DataManager,i=a.DataManager.Message,f=a.WebServer,g=a.Daemon,e=a.LocalStorage,j=a.SysTips,k=a.SysMessage,l=a.StatusIcon,m=a.RecentList,n=a.ChatDialog}};o.mix(q,o.EventTarget);var r=function(a){return"string"!=typeof a||""===a};q.on(p.CLICK_STATUS_ICON,function(){return o.log("\u70b9\u51fb\u72b6\u6001\u56fe\u6807"),d.canTalk()?(m.isOpen()?h.getTotalUnreadMsgCount()>0&&l.getmessage():l.online(),h.getTotalUnreadMsgCount()>0&&!m.isOpen()&&1===h.getTotalUnreadMsgCount()?(q.fire(p.SHOW_CHAT_DIALOG,{haveUser:{userName:"donotknow"}}),!1):!0):!1}),q.on(p.CLICK_LIGHT_ICON,function(b){o.log("\u70b9\u51fb\u4eae\u706f\u56fe\u6807");var c=b.userInfo;d.canTalk(c.key,!0)&&(c.fromLight=!0,q.fire(a.EVENTS.SHOW_CHAT_DIALOG,b))}),q.on(p.LOGIN_START,function(){0==a.Login.online||(l.onlogin(),a.Login.online=!1)}),q.on(p.LOGIN_SUCCESS,function(){o.log("\u767b\u5f55\u6210\u529f"),j.hide(),a.Login.ready=!1;for(var c,d,e=Light.lightedUsers;e.length;)if(c=e.shift(),o.log("\u81ea\u52a8\u6253\u5f00\u548c "+c+" \u7684\u804a\u5929\u7a97\u53e3"),c){if(!(d=Light.data[c])){var f=o.unparam(location.search.substring(1)),g=f.touid||f.tid;g&&(d={key:c,userName:b.getUserName(g),userId:g,status:f.status||1,itemId:f.gid,subscribed:!1}),Light.data[c]=d}d&&(d.fromLight=!0,o.later(function(){q.fire(a.EVENTS.SHOW_CHAT_DIALOG,{userInfo:d})},1e3))}var i=h.getTotalUnreadMsgCount();i>0?(o.log("\u5b58\u5728\u672a\u8bfb\u6d88\u606f "+i),l.getmessage()):l.online()}),q.on(p.ERROR_LOGIN_FAILED,function(b){o.log("\u767b\u5f55\u5931\u8d25");var c=b.error||{},e=parseInt(c.code,10);-100===e||-101===e?d.directToTBLogin():(l.offline(),j.show(a.ERROR_MESSAGE[e]||c.errorMessage||a.ERROR_MESSAGE[-1],200))}),q.on(p.SHOW_RECENT_LIST,function(){o.log("\u6253\u5f00\u6700\u8fd1\u8054\u7cfb\u4eba"),a.DataManager.isLogin()&&(f.getTalkUsers(),o.DOM.removeClass(o.DOM.get(".tstart-tdog-panel-bd","#tstart-plugin-tdog"),"tstart-panel-loading"))}),q.on(p.SHOW_CHAT_DIALOG,function(b){if(o.log("\u6253\u5f00\u804a\u5929\u7a97\u53e3"),b.haveUser&&b.haveUser.userName)f.startChat("","",{onSuccess:function(){o.log("\u83b7\u53d6\u5f00\u59cb\u804a\u5929\u6570\u636e\u5b8c\u6210\u3002")},onTimeout:function(){o.log("\u83b7\u53d6\u5f00\u59cb\u804a\u5929\u6570\u636e\u5931\u8d25","warn"),j.show(a.ERROR_MESSAGE[-1e3])}},!1);else{var c=b.userInfo||{},d=c.userName||"",e=c.userId||c.key||"",g=c.itemId||"";if(c.status=c.status||1,!(d&&!r(d)||e&&!r(e)))return j.show("\u7f51\u7edc\u51fa\u73b0\u9519\u8bef\uff0c\u8bf7\u5237\u65b0\u3002",140,2),void 0;if(o.log("\u548c "+d+" \u5f00\u59cb\u804a\u5929 fromLight = "+c.fromLight),d==h.getNickName())return alert("\u4e0d\u80fd\u9009\u62e9\u81ea\u5df1\u54e6\u3002"),void 0;if(c.fromLight)if(c.subscribed){var i=h.getUser(e);c.status=(i||{}).statusType||c.status||1}else Light.data[c.key].subscribed=!0;a.ChatDialog.show(c,0===e.indexOf("cntaobao")),f.startChat(e,g,{onSuccess:function(){o.log("\u83b7\u53d6\u5f00\u59cb\u804a\u5929\u6570\u636e\u5b8c\u6210\u3002")},onTimeout:function(){o.log("\u83b7\u53d6\u5f00\u59cb\u804a\u5929\u6570\u636e\u5931\u8d25","warn"),n.showSysTip("<p>"+a.ERROR_MESSAGE[-14]+"</p>",!0)}},c.fromLight)}}),q.on(p.RECEIVE_CHAT_MESSAGE,function(a){var b=a.unreadMsgPersonCount;o.log("\u6536\u5230"+b+"\u4e2a\u4eba\u7684\u6d88\u606f"),m.isOpen()?(m.update(),n.isOpen()):q.fire(p.UPDATE_STATUS_ICON,{data:{mSize:b}}),TStart.sendStatistic("1002.1.3")}),q.on(p.RECEIVE_SUBSCRIBE_MESSAGE,function(a){o.log("\u63a5\u6536\u5230\u7cfb\u7edf\u63d0\u9192"),k.show(a.data)}),q.on(p.RECEIVE_LOGINOUT_SIGNAL,function(){o.log("\u63a5\u6536\u5230\u65fa\u65fa\u9000\u51fa\u901a\u77e5"),l.offline(),a.SysTips.hide(),g.stop(),a.NotifyDaemon.stop(),h.clearAll(),m.close(),n.closeDialog()}),q.on(p.UPDATE_USER_STATUS,function(a){o.log("\u66f4\u65b0\u7528\u6237\u72b6\u6001\u4fe1\u606f");var c=a.data;m.isOpen()&&m.update(),n.isOpen()&&n.updateUserStatus(b.getUserName(c.changedUserId),c.status)}),q.on(p.UPDATE_STATUS_ICON,function(a){var b,c=a.data;o.log("\u66f4\u65b0\u72b6\u6001\u56fe\u6807"),b=c?c.mSize:h.getTotalUnreadMsgCount(),b>0?(o.log("\u6709\u591a\u5c11\u4eba\u672a\u8bfb\uff1a "+b),l.getmessage()):l.online()}),q.on(p.ERROR_GET_CHAT_INFO,function(){n.showSysTip("<p>"+a.ERROR_MESSAGE[-1e3]+"</p>",!0)}),q.on(p.SEND_MESSAGE,function(b){var c=b.content,d=b.userName;d.length<=8&&a.Util.detect("ww.1.20.1.1.5",h.getNickName()),o.log("\u7ed9 "+d+" \u53d1\u9001\u4ee5\u4e0b\u6d88\u606f\uff1a"+c,"info"),f.send(d,c,b.callback),TStart.sendStatistic("1002.1.2")}),q.on(p.ERROR_GET_MESSAGE,function(b){o.log("\u53d6\u670d\u52a1\u7aef\u4fe1\u606f\u5931\u8d25");var c=b.error,d=parseInt(c.code,10);-100===d||-101===d?(q.fire(p.RECEIVE_LOGINOUT_SIGNAL,{data:{subType:403}}),g.stop(),a.NotifyDaemon.stop()):j.show(a.ERROR_MESSAGE[d]||c.errorMessage||a.ERROR_MESSAGE[-1])}),q.on(a.EVENTS.DAEMON_FIRE,function(){f.get()}),a.EventCenter=q}),TDog.add("Login",function(a){var b,c,d,e,f=KISSY;a.Login={online:!1,ready:!1,init:function(){f.log("init Login"),b=a.Config,c=a.DataManager,d=a.StatusIcon,e=a.SysTips},canTalk:function(b,f){return c.getNickName()?d.isOffline()||!c.isLogin()?(f?(a.WebServer.login(),e.showLoginTips(!0)):e.showLoginTips(a.Login.ready),b&&Light.lightedUsers.push(b),!1):!0:(this.directToTBLogin(b),!1)},directToTBLogin:function(a){var c=location,d=c.protocol+"//"+c.host+c.pathname,e=c.search,g=c.hash,h=c.href,i=c.hostname,j=b.LIGHT_NICK,k=i.indexOf("daily.")>-1?!0:!1,l=function(){return k?i.indexOf("tmall")>-1?"daily.tmall.net":"daily.taobao.net":i.indexOf("tmall")>-1?"tmall.com":"taobao.com"}(),m=l.indexOf("tmall")>-1?"http://login."+l+"?redirect_url=":"https://login."+l+"/member/login.jhtml?f=top&redirectUrl=";e=e?f.unparam(e.substring(1)):{},j in e&&delete e[j],a&&(e[j]=this.isSearch()?encodeURIComponent(a):a),e=f.param(e),this.isSearch()||(e=encodeURIComponent(e)),h=d+"?"+e+g,c.href=m+h},isSearch:function(){var a=["search.taobao.com","sandbox.search.taobao.com","search8.taobao.com","search8.daily.taobao.net","s.taobao.com"];return f.indexOf(location.host,a)>-1?!0:void 0}}}),TDog.add("LocalStorage",function(a){var b,c=KISSY,d=a.Util,e=TStart,f=c.Cookie,g=d.isTaobao?"x":"otherx",h="whl",i=0,j=e.Config.DOMAIN,k={},l="_ato",m="__ll";a.LocalStorage={init:function(){k={},this.setCookieWHL("-1","0","0","0")},setItem:function(a,b){k[a]=b},getItem:function(a){return k[a]||{}},getItems:function(){var a=[];for(var b in k)a.push([b,k[b]]);return a},clear:function(){var a=c.unparam(f.get(g)),b=this;("-1"!=a[m]||0===b.getCookieWHL().messageStatus)&&(k={},b.setCookieWHL("-1","0","0","0"),b.setCookieX(m,"-1"),b.setCookieX(l,"0"))},getCookieX:function(a){return decodeURIComponent(c.unparam(f.get(g))[a])},setCookieX:function(a,b){var d=c.unparam(f.get(g));d[a]=encodeURIComponent(b);var e=c.param(d);f.set(g,e,365,j,"/")},setAndGetFocusTime:function(a){return a&&(i=a),i},setCookieWHL:function(a,b,c,d){var e=a+"&"+b+"&"+c+"&"+d;f.set(h,e,"",j,"/")},setPublicKey:function(a){b=a},getPublicKey:function(){return b||""},getCookieWHL:function(){var a=f.get(h),b=null;return a?(b=a.split("&"),4!==b.length&&(b=[-1,0,0,0])):b=[-1,0,0,0],{messageStatus:parseInt(b[0]),system:parseInt(b[1]),heartTime:parseInt(b[2]),focusTime:parseInt(b[3])}}}}),TDog.add("DataManager",function(a){var b,c,d,e,f,g=KISSY,h=g.Cookie,i=(g.JSON,a.Config),j=a.Util,k="",l=TStart.Config.isOnline,m={FIRST_RUN:"_first_run",LAST_LOGIN:"__ll",LAST_LOGIN_NAME:"_last_login_name",RECENT_LIST:"_recent_list",RECENT_LIST_NAME:"_recent_list_name",USER_LIST:"_user",MESSAGE_LIST:"_message_list"},n=a.EVENTS;a.DataManager={init:function(){var h=this;g.log("\u521d\u59cb\u5316 DataManager \u6a21\u5757"),b=a.LocalStorage,c=a.EventCenter,d=a.WebServer,e=a.Daemon,f=h.Message,f.init()},getRecentList:function(){return b.getItem(m.RECENT_LIST)},getUser:function(a){var c=b.getItem(m.RECENT_LIST);return c?c[a]:{}},setRecentList:function(a){for(var c=b.getItem(m.RECENT_LIST),d=0;d<a.length;d++){var e=c[a[d].userId];c[a[d].userId]=a[d],e&&(a[d].messageTime=e.messageTime)}b.setItem(m.RECENT_LIST,c)},updateMessageTime:function(a,c){var d=b.getItem(m.RECENT_LIST);d&&d[a]&&(d[a].messageTime=c)},getMessageTime:function(a){var b=(this.getUser(a)||{}).messageTime||"";return g.log("message time :"+b),b},getTotalUnreadMsgCount:function(){var a=b.getCookieWHL();return a.messageStatus?a.messageStatus:0},saveStartChatData:function(b){if("true"==b.success.toLowerCase()){var d=b.result,e=d.item||{},f=d.user;d.talkUserStatus.userId.length<=8&&a.Util.detect("ww.1.20.1.1.4",this.getNickName()),this.__checkOneUserMessage(d),this.__isTaobaoUser(f,e),this.__saveAndViewChatMessage(d),this.__updateNuberOfPeople(d)}else-2==b.result.error[0].code?(a.ChatDialog.closeDialog(),a.SysTips.show(a.ERROR_MESSAGE[-2],150,3)):-14==b.result.error[0].code?(a.SysTips.show(a.ERROR_MESSAGE[-14],0,!0),this.forcedUpdateNumberOfPeople(i.NOTIFY_STATUS.notMessage.value,0)):-100==b.result.error[0].code||-101==b.result.error[0].code||-12==b.result.error[0].code?c.fire(a.EVENTS.RECEIVE_LOGINOUT_SIGNAL,{data:{subType:403}}):c.fire(n.ERROR_GET_CHAT_INFO,{data:b.result,method:"start"})},handleReceiveMessage:function(b){var d=this;if("true"==b.success.toLowerCase()){var e=b.result;e.user={userChatId:e.talkUserStatus.userId},a.ChatDialog.updateUserStatus(e.talkUserStatus.userId,e.talkUserStatus.statusType),d.__saveAndViewChatMessage(e),d.__updateNuberOfPeople(e)}else-2==b.result.error[0].code?(a.ChatDialog.closeDialog(),a.SysTips.show(a.ERROR_MESSAGE[-2],150,3)):-14==b.result.error[0].code?(a.SysTips.show(a.ERROR_MESSAGE[-14],0,!0),this.forcedUpdateNumberOfPeople(i.NOTIFY_STATUS.notMessage.value,0)):-100==b.result.error[0].code||-101==b.result.error[0].code||-12==b.result.error[0].code?c.fire(a.EVENTS.RECEIVE_LOGINOUT_SIGNAL,{data:{subType:403}}):c.fire(n.ERROR_GET_CHAT_INFO,{data:b.result,method:"start"})
},clearAll:function(){a.ChatDialog.clearCurrentChatUserId(),k="",b.clear()},getNickName:function(){var a=h.get("_nk_")||"";return unescape(a.replace(/\\u/g,"%u"))},getNickUrlComponent:function(){return 0==k.length&&(k=encodeURIComponent(unescape((h.get("_nk_")||"").replace(/\\u/g,"%u")))),k},isLogin:function(){var a=this,c=!!a.getNickName(),d=b.getCookieX(m.LAST_LOGIN);return l?c&&d==a.getCookieLastLoginTime():c},getCookieLastLoginTime:function(){return j.isTaobao()?g.unparam(h.get("uc1")).lltime+h.get("lastgetwwmsg")||"-1":h.get("t")+h.get("login")||"-1"},setLastLoginTime:function(){b.setCookieX(m.LAST_LOGIN,this.getCookieLastLoginTime()),b.setCookieWHL(0,0,(new Date).getTime(),(new Date).getTime())},resetLastLoginTime:function(){b.setCookieX(m.LAST_LOGIN,"0")},haveNotFocusedPage:function(){return b.setAndGetFocusTime()===b.getCookieWHL().focusTime},setNumberOfPeople:function(a,c){var d=b.getCookieWHL();d.messageStatus!=a&&(c=2|c),b.setCookieWHL(a,c,d.heartTime,d.focusTime)},forcedUpdateNumberOfPeople:function(a,c){var d=b.getCookieWHL();b.setCookieWHL(a,c,d.heartTime,d.focusTime)},setAndGetFocusTime:function(a){if(a){var c=b.getCookieWHL();return b.setCookieWHL(c.messageStatus,c.system,c.heartTime,a),b.setAndGetFocusTime(a),a}return b.setAndGetFocusTime()},addMessage:function(a,c){var d=b.getItem(m.MESSAGE_LIST);if(d[a]){for(var e=0;e<c.length;e++)j.contains(d[a],c[e])||d[a].push(c[e]);for(;d[a].length>20;)d[a].shift()}else d[a]=c},addAllMessage:function(a,c){var d=b.getItem(m.MESSAGE_LIST);for(d[a]=c,b.setItem(m.MESSAGE_LIST,d);c.length>20;)c.shift()},deleteMessage:function(a){var c=b.getItem(m.MESSAGE_LIST);c[a]&&(c[a]=[]),b.setItem(m.MESSAGE_LIST,c)},getAllMessages:function(a){return b.getItem(m.MESSAGE_LIST)[a]||[]},getHeartTime:function(){return b.getCookieWHL().heartTime},setHeartTime:function(a){var c=b.getCookieWHL();b.setCookieWHL(c.messageStatus,c.system,a,c.focusTime)},startHeartTime:function(a){var c=b.getCookieWHL();b.setCookieWHL(c.messageStatus,c.system,a,c.focusTime)},setMessageStatus:function(a,c){var d=b.getCookieWHL();b.setCookieWHL(a,c,d.heartTime,d.focusTime)},getCookieWHL:function(){return b.getCookieWHL()},setCookieWHL:function(a,c,d,e){b.setCookieWHL(a,c,d,e)},getLoginKey:function(){return b.getPublicKey()},setLoginKey:function(a){b.setPublicKey(a)},__checkOneUserMessage:function(b){if(b.talkUserStatus&&b.talkUserStatus.userId){var c=b.talkUserStatus;if(c.userId.length<=8&&a.Util.detect("ww.1.20.1.1.8",this.getNickName()),b.single){var d={userName:b.user.nick,userId:c.userId,relation:c.relation,status:c.statusType};a.ChatDialog.show(d,0===d.userId.indexOf("cntaobao"))}else a.ChatDialog.updateUserStatus(b.user.nick,c.statusType)}},__isTaobaoUser:function(b,c){if(0===b.userChatId.indexOf("cntaobao")){var d=c.title?{user:b,item:c}:{user:b};a.ChatDialog.showInfo(d)}},__saveAndViewChatMessage:function(b){var c=b.user;this.updateMessageTime(c.userChatId,b.timeStamp),b.messages&&b.messages.length&&(b.all?this.addAllMessage(c.userChatId,b.messages):this.addMessage(c.userChatId,b.messages)),a.ChatDialog.updateMsg()},__updateNuberOfPeople:function(a){this.forcedUpdateNumberOfPeople(a.size,0),0==a.size?c.fire(n.UPDATE_STATUS_ICON,{data:{mSize:0}}):c.fire(n.RECEIVE_CHAT_MESSAGE,{unreadMsgPersonCount:a.size})},hash:function(){return[2,13,28,9,18,27,23,20,17,27,7,9,29,25,5,24]}}}),TDog.add("DataManager.Message",function(a){var b,c,d,e,f,g,h=KISSY,i=a.DataManager,j=a.EVENTS,k=a.MESSAGE_SUBTYPE,l=a.MESSAGE_TYPE;h.isPlainObject(i)&&(i.Message={init:function(){h.log("\u521d\u59cb\u5316 Message \u6a21\u5757"),b=a.LocalStorage,c=a.EventCenter,d=a.Daemon,e=a.NotifyDaemon,g=a.WebServer,f=a.ChatDialog},saveGetData:function(a){var b,d,e,f=0;if("true"==a.success.toLowerCase()&&a.result.messages){e=a.result.messages,f=a.result.size;for(var g=0,i=e.length;i>g;g++)switch(b=e[g],d=parseInt(b.subType,10),parseInt(b.type,10)){case l.LOGOUT:return h.log("\u6536\u5230\u9000\u51fa\u901a\u77e5\uff0c\u505c\u6b62\u8bf7\u6c42\u8f6e\u8be2","warn"),c.fire(j.RECEIVE_LOGINOUT_SIGNAL,{data:b}),void 0;case l.STATUS:var m=b.changedUserId||"";m&&(h.log("\u6536\u5230\u7528\u6237 "+m+" \u7684\u72b6\u6001\u66f4\u65b0\u4fe1\u606f"),c.fire(j.UPDATE_USER_STATUS,{data:b}));break;case l.SYSTEM:switch(d){case k.SUBSCRIBE_MESSAGE:c.fire(j.RECEIVE_SUBSCRIBE_MESSAGE,{data:b});break;case k.POPUP_MESSAGE:c.fire(j.RECEIVE_POPUP_MESSAGE,{data:b})}break;case l.OFFLINE:case l.SELF:case l.TALK:h.log("\u63a5\u53d7\u5230\u6b63\u5e38\u7684\u804a\u5929\u6570\u636e,ERROR`")}}},checkCurrentUserMessage:function(a,b){var c=f.getCurrentChatUserId();return c?(g.receiveMessage(c,b,a),!0):!1},clearAll:i.clearAll})}),TDog.add("Daemon",function(a){var b,c,d,e,f,g,h,i,j,k,l,m=KISSY,n=m.Event,o=!1,p=!1,q=800,r=1200;a.Daemon={init:function(){m.log("\u521d\u59cb\u5316 Daemon \u6a21\u5757");var n=this;b=a.Util,c=a.EventCenter,d=a.LocalStorage,e=a.WebServer,f=a.DataManager,g=a.Config,h=a.StatusIcon,j=a.SysTips,i=a.NotifyDaemon,k=a.ChatDialog,l=a.EVENTS,n._bindEvent()},start:function(){var a=this;p=!0,o=!0,f.setAndGetFocusTime((new Date).getTime()),a.fire()},fire:function(){try{var a=this;a.timer&&a.timer.cancel();var b=k.isOpen()?q:r,d=null;p&&o?(d=f.getCookieWHL(),d.system>0&&(f.setCookieWHL(d.messageStatus,0,d.heartTime,d.focusTime),1==(1&d.system)&&c.fire(l.DAEMON_FIRE),2==(2&d.system)&&f.Message.checkCurrentUserMessage(!1,!0))):a.notHaveFocusedPage()&&(d=f.getCookieWHL(),2==(2&d.system)&&(f.setCookieWHL(d.messageStatus,0,d.heartTime,d.focusTime),f.Message.checkCurrentUserMessage(!1,!1))),a.execute(d,b)}catch(e){m.log("\u8f6e\u8be2\u51fa\u9519\u4e86\u3002"),a.timer&&a.timer.cancel(),a.timer=m.later(function(){a.fire()},q)}},execute:function(a,b){var d=this;return g.NOTIFY_STATUS.logout.value==a.messageStatus?(c.fire(l.RECEIVE_LOGINOUT_SIGNAL,{data:{subType:403}}),void 0):(a.messageStatus>0&&(k.isOpen()||h.onNewMessage()||c.fire(l.RECEIVE_CHAT_MESSAGE,{unreadMsgPersonCount:a.messageStatus})),d.timer=m.later(function(){d.fire()},b),void 0)},stop:function(){var a=this;p&&(m.log("\u505c\u6b62\u672c\u5730\u8f6e\u8be2\u3002"),a.timer&&a.timer.cancel(),p=!1)},notHaveFocusedPage:function(){return f.haveNotFocusedPage()},isFocused:function(){return o},_bindEvent:function(){var b=this,d=window;o=!0,f.setAndGetFocusTime((new Date).getTime()),n.on(d,"focus",function(){m.log("\u5f53\u524d\u7a97\u53e3\u83b7\u5f97\u7126\u70b9"),o=!0,f.isLogin()?o&&(b.notHaveFocusedPage()||(f.setAndGetFocusTime((new Date).getTime()),f.Message.checkCurrentUserMessage(!1,!0)),b.start(),i.restart(),j.hide(),c.fire(l.RECEIVE_CHAT_MESSAGE,{unreadMsgPersonCount:f.getTotalUnreadMsgCount()})):c.fire(a.EVENTS.RECEIVE_LOGINOUT_SIGNAL,{data:{subType:403}})}),n.on(d,"blur",function(){m.log("\u5f53\u524d\u7a97\u53e3\u5931\u53bb\u7126\u70b9\u3002"),o=!1})}};var s=7e3,t=!1,u=-9,v=15e3,w=1,x=void 0;a.NotifyDaemon={init:function(){var a=this;a.restart(),m.log("\u521d\u59cb\u5316\u957f\u8fde\u63a5\u90e8\u4efd.")},start:function(){var a=this;t=!0,f.startHeartTime(u),a.__createConnection(),m.log("\u767b\u5f55\u5b8c\u6210\uff0c\u5f00\u59cb\u957f\u8fde\u63a5.")},restart:function(){var a=this;t=!0,a.__heartTimeout()},stop:function(){var a=this;t&&(m.log("\u505c\u6b62\u5916\u90e8\u957f\u94fe\u63a5\u68c0\u67e5\u3002"),a.heartTimeoutTimer&&a.heartTimeoutTimer.cancel(),t=!1)},__createConnection:function(){try{x=document.createElement("iframe"),x.width=0,x.height=0,x.style.display="none",x.src=g.notifyUrl;var a=document.getElementsByTagName("body")[0];a.appendChild(x,a.lastChild)}catch(b){m.log("\u8fdc\u7a0b\u8fde\u63a5\u5f02\u5e38\u4e86\u2026\u2026"+b)}},__heartTimeout:function(){var a=this;a.heartTimeoutTimer&&a.heartTimeoutTimer.cancel(),t&&(a.heartTimeoutTimer=m.later(function(){var b=f.getCookieWHL();m.log("\u68c0\u67e5\u957f\u94fe\u63a5\uff0c\u91cd\u65b0\u5f00\u59cb:"+((new Date).getTime()-b.heartTime>s)+","+((new Date).getTime()-b.heartTime)+","+(new Date).getTime()+","+b.heartTime),(b.heartTime==u||(new Date).getTime()-b.heartTime>s&&b.heartTime!==u&&b.messageStatus!==g.NOTIFY_STATUS.logout.value)&&(x?(m.log("\u957f\u94fe\u63a5\u7684frame\u5df2\u7ecf\u5b58\u5728\u3002"),x.src=g.notifyUrl):(a.__createConnection(),m.log("\u957f\u94fe\u63a5\u7684frame\u4e0d\u5df2\u7ecf\u5b58\u5728\u3002")),f.setHeartTime(u),t=!0,a.__checkConnection()),a.__heartTimeout()},s))},__checkConnection:function(){var a=this;w++<4&&m.later(function(){f.getHeartTime()===u&&(x?(m.log("\u957f\u94fe\u63a5\u7684frame\u5df2\u7ecf\u5b58\u5728\u3002"),x.src=g.notifyUrl):(a.__createConnection(),m.log("\u957f\u94fe\u63a5\u7684frame\u4e0d\u5df2\u7ecf\u5b58\u5728\u3002")))},v)}}}),TDog.add("WebServer",function(a){var b=KISSY,c=(b.Cookie,a.Config),d=a.DataManager,e=a.EVENTS,f=a.EventCenter,g=a.Daemon,h=0,i=5e3,j=a.SITES,k=j.TAOBAO,l=1,m=0,n={getToken:{url:c.getTokenUrl,callback:"TDog.WebServer.globalToken"},login:{url:c.loginUrl,callback:"TDog.WebServer.prepareLogin"},checkautologin:{url:c.checkAutoLogin,callback:"TDog.WebServer.decideAutoLogin"},getloginresult:{url:c.getLoginResultUrl,callback:"TDog.WebServer.disposeLoginResult"},setstrangermsg:{url:c.setAutoLoginUrl,callback:"TDog.WebServer.setStrangerMsgData"},clearchatlist:{url:c.clearListUrl,callback:"TDog.WebServer.clearChatListData"},clearchatmessage:{url:c.clearListUrl,callback:"TDog.WebServer.handClearChatMessage"},setautologin:{url:c.setAutoLoginUrl,callback:"TDog.WebServer.setAutoLoginData"},start:{url:c.startUrl,callback:"TDog.DataManager.saveStartChatData"},receive:{url:c.startUrl,callback:"TDog.DataManager.handleReceiveMessage"},send:{url:c.sendUrl,callback:"TDog.WebServer.handleSendResult"},get:{url:c.getUrl,callback:"TDog.DataManager.Message.saveGetData"},getTalkUsers:{url:c.getTalkUsers,callback:"TDog.WebServer.handleTalkUsers"},ackGetMessage:{url:c.ackGetMessage,callback:"TDog.WebServer.handleAckResult"},checkUserSeting:{url:c.ackGetMessage,callback:"TDog.WebServer.handUserSeting"},getServerKey:{url:c,callback:"TDog.WebServer.handleLoginFirst"}};a.WebServer={AUTO_LOGIN:{autoLoginAndTip:1,autoLoginNotTip:2,forcedLogin:3},init:function(){var a=this;a.getTokenNum=1,b.log("\u521d\u59cb\u5316 WebServer \u6a21\u5757"),a.getToken()},_request:function(e,f){var g=d.getNickUrlComponent(),h=0==g.length?"":"&nkh="+g;e=e+h+"&appId="+c.appId,b.log("["+new Date+"] "+e+"&t="+ +new Date,"info"),b.isFunction(f.onFailure)&&(f.onFailure=f.onTimeout),a.Util.getScript(e+"&t="+ +new Date,{onSuccess:function(){b.isFunction(f.onSuccess)&&f.onSuccess.call(this)},onFailure:function(){b.isFunction(f.onFailure)&&f.onFailure.call(this)},onTimeout:function(){b.isFunction(f.onTimeout)&&f.onTimeout.call(this)},success:function(){"function"==typeof f.onSuccess&&f.onSuccess.call(this)},error:function(){"function"==typeof f.onFailure&&f.onFailure.call(this)},scope:this,charset:c.charset||"gbk",timeout:i})},sitePrefix:function(){var a=[];for(var b in j)a.push(j[b]);return new RegExp("^("+a.join("|")+")(.*)$","i")}(),formatNick:function(a){var b=this,c=b.sitePrefix;return c.test(a)?a:k+a},getNick:function(a){if(a){var b=this,c=b.sitePrefix,d=a.match(c);return d?"undefined"!=typeof d[2]&&d[2]?d[2]:a:a}},getToken:function(){var a=this,d="getToken",e=b.param({callback:n[d].callback});a._request(c.getTokenUrl+"?"+e,{})},setAutoLogin:function(a){var d=this,e="setautologin",f=b.param({token:d.token,callback:n[e].callback});d._request(c.setAutoLoginUrl+"?act="+a+"&"+f,{})},setAutoLoginData:function(a){this.__handleErrorResult(a)},setStrangerMsg:function(a){var d=this,e="setstrangermsg",f=b.param({token:d.token,callback:n[e].callback});d._request(c.setAutoLoginUrl+"?act="+a+"&"+f,{})},setStrangerMsgData:function(a){this.__handleErrorResult(a)},clearChatList:function(){var a=this,d="clearchatlist",e=b.param({token:a.token,callback:n[d].callback});a._request(c.clearListUrl+"&"+e,{})},clearChatListData:function(a){this.__handleErrorResult(a)},clearChatMessage:function(a){var d=this,e="clearchatmessage",f=b.param({act:1,targetNick:a,token:d.token,callback:n[e].callback});d._request(c.clearUrl+"?"+f,{})},handClearChatMessage:function(a){this.__handleErrorResult(a)},checkAutoLogin:function(a){var d=this,e="checkautologin",f=b.param({token:d.token,callback:n[e].callback,check:"1"});d._request(c.checkAutoLoginUrl+"?cat=-1&"+f,a||{})},checkUserSeting:function(a){var d=this,e="checkUserSeting",f=b.param({token:d.token,callback:n[e].callback});d._request(c.checkAutoLoginUrl+"?cat=-1&"+f,a||{})},globalToken:function(c){var h=this;h.getTokenNum>3||(h.getTokenNum++,"true"===c.success.toLowerCase()?(h.token=c.result.token,g.init(),d.isLogin()?(f.fire(e.LOGIN_SUCCESS),a.NotifyDaemon.init(),g.start()):d.getNickName()?(a.LocalStorage.init(),h.checkAutoLogin()):(a.LocalStorage.init(),b.log("\u963f\u91cc\u65fa\u65fa\uff08\u672a\u767b\u5f55\uff09"),a.SysTips.setHoverTips("\u963f\u91cc\u65fa\u65fa\uff08\u672a\u767b\u5f55\uff09"))):h.getToken())},handUserSeting:function(a){var c=this;if(c.__handleErrorResult(a),"true"===a.success.toLowerCase()){var d=a.result,e=!(8192&parseInt(d.tag,10)),f=16384&parseInt(d.tag,10);b.get("#tstart .tstart-settings-login").checked=e?!0:!1,b.get("#tstart .tstart-settings-msg").checked=f?!0:!1}},decideAutoLogin:function(c){var d=this;if(d.__handleErrorResult(c),"true"===c.success.toLowerCase())if(-1==c.result.tag)d.__completeLogin();else{var e=c.result,f=!(8192&parseInt(e.tag,10)),g=a.Config.forceAutoLogin;f&&b.UA.ie?d.login(d.AUTO_LOGIN.autoLoginNotTip):g?(b.log("\u6ee1\u8db3\u81ea\u52a8\u767b\u5f55\u6761\u4ef6\uff0c\u53d1\u8d77\u767b\u5f55\u8bf7\u6c42"),d.login()):b.log("\u4e0d\u6ee1\u8db3\u81ea\u52a8\u767b\u5f55\u6761\u4ef6")}},prepareLogin:function(b){var c=this;if("false"==b.success.toLowerCase()){var d=parseInt((b.result.error[0]||{}).code)||0;switch(d){case-15:a.SysTips.showClientOnlineTips(),a.Util.sendLog("wwweblog=logged");break;case-16:break;default:f.fire(e.ERROR_LOGIN_FAILED,{error:b.result.error[0]})}}else c.getLoginResult()},getLoginResult:function(){var i=this;b.log("\u767b\u5f55\u6210\u529f\uff0c\u8fc7 1 \u79d2\u949f\u83b7\u53d6\u767b\u5f55\u540e\u7684\u7ed3\u679c"),b.later(function(){var j=b.param({time:l,token:i.token,callback:n.getloginresult.callback});i._request(c.getLoginResultUrl+"?"+j,{onSuccess:function(){b.log("\u4e8c\u6b21\u8bf7\u6c42\u5f97\u5230\u767b\u5f55\u7ed3\u679c\u767b\u5f55\u5b8c\u6210"),d.isLogin()&&(i.get(),a.NotifyDaemon.start(),g.start(),f.fire(e.LOGIN_SUCCESS),a.SysTips.show("\u963f\u91cc\u65fa\u65fa - "+d.getNickName()+"(\u5728\u7ebf)","150",5),h=(new Date).getTime(),l=1)},onFailure:function(){f.fire(e.RECEIVE_LOGINOUT_SIGNAL,{data:{subType:403}})},onTimeout:function(){f.fire(e.RECEIVE_LOGINOUT_SIGNAL,{data:{subType:403}})}})},1e3*l)},disposeLoginResult:function(a){var c=this;b.log("\u767b\u5f55:"+a.success),"true"===a.success.toLowerCase()?d.setLastLoginTime():++l<4&&a.result.error&&-99==a.result.error[0].code?c.getLoginResult():(l=1,d.resetLastLoginTime(),f.fire(e.ERROR_LOGIN_FAILED,{error:(a.result.error||[])[0]}))},login:function(a,g){var h,i=this,j="login",k=i.__encrypt();k&&(h=b.param({token:i.token,callback:n[j].callback,nickName:d.getNickName(),autoLogin:a||i.AUTO_LOGIN.autoLoginAndTip,loginTag:k}),f.fire(e.LOGIN_START),b.log("\u8bf7\u6c42\u767b\u5f55\u5f00\u59cb"),i._request(c.loginUrl+"?"+h,g||{}))},startChat:function(a,e,f,g){var h,i=this,j="start";h=b.param({token:i.token,callback:n[j].callback,userId:a,itemId:e||"",fromLight:g?"true":"false",time:d.getMessageTime(a)}),i._request(c.startUrl+"?"+h,f||{})},receiveMessage:function(a,e,f,g){var h,i=this,j="receive";h=b.param({token:i.token,callback:n[j].callback,targetUserChatId:a,focused:e,update:f,time:d.getMessageTime(a)}),i._request(c.receiveUrl+"?"+h,g||{})},send:function(d,e,f){var g,h=this;return d.length<=8||!e.length?(a.ChatDialog.showSysTip("<p><span>\u6d88\u606f\u53d1\u9001\u5931\u8d25\uff0c\u8bf7\u5c1d\u8bd5\u91cd\u65b0\u6253\u5f00\u804a\u5929\u7a97\u53e3\uff01</span></p>"),void 0):(d=h.formatNick(d),g=b.param({token:h.token,callback:n.send.callback,userId:d,content:e}),h._request(c.sendUrl+"?"+g,f||{}),void 0)},handleSendResult:function(a){this.__handleErrorResult(a)},get:function(){var a,d=this,e="get";b.log("\u8f6e\u8be2\u83b7\u53d6\u4fe1\u606f"),a=b.param({token:d.token,callback:n[e].callback}),d._request(c.getUrl+"?"+a,{})},getTalkUsers:function(a){var d=this,e="getTalkUsers",f=b.param({token:d.token,callback:n[e].callback});d._request(c.getTalkUsers+"?"+f,a||{}),b.log("\u53d6\u804a\u5929\u4eba\u5217\u8868\u3002")},handleTalkUsers:function(){var c=1;return function(e){var f=a.WebServer.__handleErrorResult(e);"true"==e.success?(b.log("\u66f4\u65b0\u8054\u7cfb\u4eba\u5217\u8868\u6210\u529f\uff1a"+c),a.RecentList.updateRecentlist(e.result.person),e.result.person.length>0&&d.setRecentList(e.result.person),d.forcedUpdateNumberOfPeople(e.result.size,0)):c++<4&&!f?(b.log("\u66f4\u65b0\u8054\u7cfb\u4eba\u5217\u8868\u5931\u8d25\uff0c\u91cd\u8bd5\uff1a"+c),a.WebServer.getTalkUsers({})):b.log("\u66f4\u65b0\u8054\u7cfb\u4eba\u5217\u8868\u5931\u8d25\uff0c\u91cd\u8bd5\u4e09\u6b21\u6216\u9000\u51fa\u767b\u5f55\u7ed3\u675f\u3002")}}(),ack:function(a,d,e){var f,g=this;f=b.param({token:g.token,callback:n.ackGetMessage.callback,userId:a,num:d}),g._request(c.ackGetMessage+"?"+f,e||{})},handleAckResult:function(a){b.log("\u6536\u5230\u6d88\u606f\u5e94\u7b54:"+a.success),this.__handleErrorResult(a)},__handleErrorResult:function(b){return"false"!==b.success||!b.result.error[0]||-100!=b.result.error[0].code&&-101!=b.result.error[0].code&&-12!=b.result.error[0].code?!1:(f.fire(a.EVENTS.RECEIVE_LOGINOUT_SIGNAL,{data:{subType:403}}),!0)},__encrypt:function(){var a=this,b=d.getLoginKey();return b.length?a.__encryptKey():(a.__getServerKey(),void 0)},__getServerKey:function(){var a,d=this,e="getServerKey";a=b.param({token:d.token,callback:n[e].callback}),d._request(c.TagKeyUrl+"?"+a,{})},__encryptKey:function(){for(var a="",b=this,c=d.getLoginKey(),e=b.__make(),f=0;f<e.length;f++)a+=c.charAt(e[f]);var g=encodeURIComponent(d.getNickName()).charAt(2);return g+a},handleLoginFirst:function(a){var b=this;"true"==a.success?(d.setLoginKey(a.result.tagKey),m++<3&&b.login()):f.fire(e.ERROR_LOGIN_FAILED,{error:a.result.error[0]})},__make:function(){for(var a=[],e=d.hash(),f=c.hash,g=0;16>g;g++)a.push(Math.floor(e[g]+100*(f[g]/7.3))%32);return b.log("hash:"+a.join(",")),a},__completeLogin:function(){b.log("\u5df2\u7ecf\u767b\u5f55\u8fc7\u540e\uff0c\u5b8c\u6210\u767b\u5f55\u3002"),d.setLastLoginTime(),d.isLogin()&&(this.get(),a.NotifyDaemon.start(),g.start(),f.fire(e.LOGIN_SUCCESS),h=(new Date).getTime(),l=1)},uptime:function(){return h}}}),TDog.add("RecentList",function(a){var b,c,d,e=KISSY,f=e.DOM,g=e.Event,h=a.DataManager,i=a.EventCenter,j=a.Util,k='<div class="tdog-recentlist"><ul>{ITEMS}</ul></div>',l='<li class="tdog-recentlist-item tdog-status-{status}"><i></i><span class="tdog-user-name" id="{userId}">{userName}</span><span class="tdog-msg-count">{msgCount}</span></li>';a.RecentList={init:function(){c=a.hostEl,b=a.ChatDialog,d=e.get(".tstart-tdog-panel-bd",a.hostEl),this._bindUI()},update:function(){a.WebServer.getTalkUsers()},updateRecentlist:function(c){var g,h=c.length,i="";for(e.log("\u66f4\u65b0\u8054\u7cfb\u4eba\u5217\u8868"),0===h?(i='<p class="tdog-recentlist-none">\u6682\u65e0\u8054\u7cfb\u4eba</p>',f.addClass(e.get(".tstart-tdog-panel-clearbtn",a.hostEl),"hidden")):f.removeClass(e.get(".tstart-tdog-panel-clearbtn",a.hostEl),"hidden"),g=h-1;g>=0;--g)c[g].size=0==c[g].size||void 0==c[g].size||c[g].userId==b.getCurrentChatUserId()?"":"("+c[g].size+")",c[g].userName=a.Util.getUserName(c[g].userId),c[g].status=c[g].statusType,i+=j.substitute(l,{status:a.USER_STATUS[c[g].status][0],userName:j.getUserName(c[g].userId),msgCount:c[g].size,userId:c[g].userId});i=k.replace("{ITEMS}",i),d.innerHTML=i,f.removeClass(f.get(".tstart-tdog-panel-bd","#tstart-plugin-tdog"),"tstart-panel-loading")},close:function(){f.removeClass(a.hostEl,"tstart-item-active"),a.DataManager.isLogin()&&h.getTotalUnreadMsgCount()>0&&a.StatusIcon.getmessage()},isOpen:function(){return f.hasClass(c,"tstart-item-active")},_bindUI:function(){var b,c=function(a){var b=a.target;return"LI"==b.parentNode.nodeName.toUpperCase()&&(b=b.parentNode),"LI"==b.nodeName.toUpperCase()?b:!1},j=this;g.on(d,"click",function(d){if(b=c(d)){var f=e.get(".tdog-user-name",b).id;if(a.ChatDialog.checkDialogOpen(f))return;var g=h.getUser(f);g&&(i.fire(a.EVENTS.SHOW_CHAT_DIALOG,{userInfo:g}),e.get(".tdog-msg-count",b).innerHTML="")}}),g.on(d,"mouseover mouseout",function(a){b=c(a),b&&"true"!=b.getAttribute("current")&&f.toggleClass(b,"tdog-recentlist-hover")}),g.on(d,"mousedown mouseup",function(a){b=c(a),b&&f.toggleClass(b,"tdog-recentlist-select")}),g.on(window,"click",function(){h.isLogin()&&h.getTotalUnreadMsgCount()>0&&a.StatusIcon.getmessage()}),g.on(a.hostEl,"click",function(b){var c=b.target;f.hasClass(c,"tstart-tdog-panel-clearbtn")&&(a.WebServer.clearChatList(),e.get("#tstart .tdog-recentlist").innerHTML='<ul><p class="tdog-recentlist-none">\u6682\u65e0\u8054\u7cfb\u4eba</p></ul>',f.addClass(e.get(".tstart-tdog-panel-clearbtn",a.hostEl),"hidden")),(f.hasClass(c,"tstart-tdog-panel-closebtn")||"img"===c.tagName.toLowerCase()&&f.parent(c,".tstart-tdog-panel-closebtn"))&&j.close()})}}}),TDog.add("ChatDialog",function(a){var b,c,d,e,f=KISSY,g=f.DOM,h=f.Event,i=TStart,j=encodeURIComponent,k=a.EventCenter,l=a.WebServer,m=a.Config,n=a.Util,o=document,p=window,q=i.Config.DOMAIN,r=(i.Config.isOnline,[]),s=null,t=null,u='<div class="tdog-popup-tms-bullet"><div class="tdog-popup-tms-bulletin"></div></div>',v='<div class="tdog-popup tdog-popup-blue '+(f.UA.ie?"tdog-ie":"")+'" style="width:416px;bottom:40px;overflow:normal;">'+'<div class="tdog-popup-head" >'+'<div><i class="tdog-status-"></i><div><span class="tdog-popup-contact"></span></div></div>'+'<span class="tdog-popup-tools">'+'<span title="\u5e2e\u52a9" class="tdog-popup-help"></span><span title="\u5173\u95ed" class="tdog-popup-close"></span>'+"</span>"+"</div>"+'<div class="tdog-popup-main">'+'<div class="tdog-popup-talkleftouter">'+'<div class="tdog-popup-talkleftinner"><div class="tdog-popup-talkcontainer">'+u+'<div class="tdog-popup-talkhistory">'+"</div>"+'<div class="tdog-popup-talkbar">'+'    <span title="\u8868\u60c5"></span>'+'    <span class="tdog-popup-talkbar-clear" title="\u6e05\u7a7a\u804a\u5929\u8bb0\u5f55"></span>'+"</div>"+'<div class="tdog-popup-talkinput">'+'    <textarea cols="5"></textarea>'+'</div><a title="\u9690\u85cf\u53f3\u8fb9\u680f" class="tdog-popup-pulloff" href="javascript:void(0);"><span></span></a></div>'+'<div class="tdog-popup-talkfoot">'+'<span class="tdog-popup-tms-ad">'+"</span>"+'   <span class="tdog-popup-sendbut">'+'     <span class="tdog-popup-send">\u53d1\u9001</span>'+'     <span class="tdog-popup-changesend"></span>'+"<ul>"+"<li><i></i><span>\u6309Ctrl+Enter\u53d1\u9001</span></li>"+'<li class="tdog-send-mode"><i></i><span>\u6309Enter\u53d1\u9001</span></li>'+"</ul>"+"</span>"+"</div>"+"</div>"+"</div>"+'<div class="tdog-popup-talkright">'+"</div>"+'<div class="tdog-popup-clear"></div>'+"</div>"+'<div class="tdog-popup-handle"></div>'+'<div class="tdog-popup-handle-x"></div>'+'<div class="tdog-popup-handle-y"></div>'+"</div>";a.ChatDialog={init:function(){},showAdLink:function(a,b){var c=f.get("a.tdog-popup-tms-link",b);c&&a.href&&a.title&&(c.innerHTML=a.title,g.attr(c,"href",a.href),s=a)},showBulletin:function(a){f.later(function(){var b,d=f.get("div.tdog-popup-tms-bulletin",c),e=f.get("div.tdog-popup-talkhistory",c),h=f.get("div.tdog-popup-talkright",c),i="none"!=h.style.display?"tdog-popup-pulloff":"tdog-popup-pullon",j=(f.get("a."+i,c),f.get("span.tdog-popup-tms-ad",c));if(d&&a.title&&a.url&&a.href){var k=o.createElement("div");k.className="tdog-popup-tms-bulletin-close",d.innerHTML="<i></i><a href="+a.url+" target='_blank'>"+a.title+"</a>",d.appendChild(k),"taobao"==a.href&&"taobao.com"==q?g.css(d.parentNode,"display","block"):"daily"==a.href&&"taobao.net"==q&&g.css(d.parentNode,"display","block"),b=d.innerHTML&&"block"==g.parent(d).style.display?e.offsetHeight-22:e.offsetHeight,g.css(e,"height",b),t=a}j&&a.adUrl&&a.adText&&(j.innerHTML="<a href="+a.adUrl+" target='_blank'>"+a.adText+"</a>"),e&&(e.scrollTop=e.scrollHeight)},800,!1)},_create:function(c){var d=l.formatNick(e.userId);if(c)b=g.create(v);else{var i,k,o='<a title="\u9690\u85cf\u53f3\u8fb9\u680f" class="tdog-popup-pullon" style="display:none"></a></div></div><div class="tdog-popup-talkright" ></div>';i=v.replace(o,"</div></div>"),b=g.create(i),g.css(b,"width","253px"),k=f.get("div.tdog-popup-talkleftinner",b),g.css(f.get("div.tdog-popup-talkright",b),"display","none"),g.css(k,"margin-right","6px"),g.css(f.get("div.tdog-popup-talkhistory",b),"width","auto")}r.push(new Array(d,b)),f.get("#tstart").appendChild(b),c||(f.get("a.tdog-popup-pulloff").style.display="none"),g.css(b,"display","block"),this._bindUI(b);var p=f.get("div.tdog-popup-talkbar",b).getElementsByTagName("a")[0],q=j(j(j(a.DataManager.getNickName()))),s=j(j(j(d))),u="http://www2.im.alisoft.com/webim/online/chat_record_search.htm?from_im=webwangwang&signmode=im&type=0&u_id=cntaobao"+q+"&t_id="+s+"&sign_account="+q;p&&(p.href="http://sign.im.alisoft.com/sign/aso?domain=taobao&target="+u+"&_input_charset=utf-8");var w=new f.Drag(b,{handle:".tdog-popup-head",not:[".tdog-popup-help",".tdog-popup-close"],scroll:!0});w.onStartDrag=function(a,b){g.css(b,"bottom","auto")},h.on(f.get("div.tdog-popup-head",b),"selectstart",function(a){a.halt()}),DragFn=function(a,b,c,d,e,h){var i=h,j=f.get("div.tdog-popup-talkhistory",i),k=f.get("div.tdog-popup-talkright",i),l=f.get("div.tdog-popup-main",i),m=f.get("a.tdog-popup-pulloff",i),n=f.get("span.tdog-popup-sendbut",i),o=f.get("a.tdog-popup-pullon",i),p=f.get("div.tdog-popup-tms-bullet",i),q="block"==p.style.display?b.offsetHeight-163+"px":b.offsetHeight-141+"px";g.hasClass(i,"tdog-popup-visible")&&g.removeClass(i,"tdog-popup-visible"),g.css(j,"width","auto"),g.css(j,"marginRight","5px"),g.css(l,"height",b.offsetHeight-28+"px"),"none"!==g.css(k,"display")&&g.css(k,"height",b.offsetHeight-37+"px"),g.css(j,"height",q),g.css(function(){return m?m:o}(),"height",b.offsetHeight-141+"px"),6===f.UA.ie&&(g.addClass(n,"reflow-fix"),g.removeClass(n,"reflow-fix"))};var x=new f.Drag(b,{resize:!0,handle:".tdog-popup-handle",resizefn:[417,291]});x.onStartDrag=function(a,c,d){var e=f.get("div.tdog-popup-talkright",b);d.resizefn="none"===g.css(e,"display")?[270,291]:[417,291]},x.onDrag=function(a,b,c,d,e,f){DragFn(a,b,c,d,e,f)};var y=new f.Drag(b,{resize:!0,handle:".tdog-popup-handle-x",resizefn:[!1,291]});y.onDrag=function(a,b,c,d,e,f){DragFn(a,b,c,d,e,f)};var z=new f.Drag(b,{resize:!0,handle:".tdog-popup-handle-y",resizefn:[417,!1]});return z.onStartDrag=function(a,b,c,d,e,h){var i=h,j=f.get("div.tdog-popup-talkright",i);c.resizefn="none"===g.css(j,"display")?[270,!1]:[417,!1]},z.onDrag=function(a,b,c,d,e,f){DragFn(a,b,c,d,e,f)},n.getTmsContent([{data:t,link:m.tmsBulletinUrl,callback:"TDog.ChatDialog.showBulletin",success:function(){f.log("\u8bfb\u53d6 TMS \u6587\u5b57\u94fe\u8d44\u6e90\u6210\u529f")},hasDate:null,notHasDate:null}]),b},show:function(b,d){e=b;var h,i,j=this,k=l.formatNick(e.userId),m=!1;k.length<=8&&a.Util.detect("ww.1.20.1.1.7",a.DataManager.getNickName());for(var n=0;n<r.length;n++)r[n][0]==k?(r[n][1].style.display="block",c=r[n][1],m=!0):r[n][1].style.display="none";if(m){var o,p=f.get("div.tdog-popup-head",c),q=f.get("div",p);o=e.status?" - "+a.USER_STATUS[b.status][1]:"",e.relation?"\u597d\u53cb":"\u964c\u751f\u4eba",q.innerHTML='<i></i><div class="tdog-contact-info"><span class="tdog-popup-contact">'+e.userName+"</span>"+o+"</div>",q.className="tdog-status-"+a.USER_STATUS[b.status][0],this.changeBut()}else f.use("dragdrop",function(){c=j._create(d),h=g.viewportWidth(),i=(h-440)/2,c.style.left=i+"px";var k,l=f.get("div.tdog-popup-head",c),m=f.get("div",l);k=e.status?" - "+a.USER_STATUS[b.status][1]:"",e.relation?"\u597d\u53cb":"\u964c\u751f\u4eba",m.innerHTML='<i></i><div class="tdog-contact-info"><span class="tdog-popup-contact">'+e.userName+"</span>"+k+"</div>",m.className="tdog-status-"+a.USER_STATUS[b.status][0],j.changeBut()})},closeDialog:function(){n.css([[c,"display","none"],["tdog-face-container","display","none"]]),c=!1,e=""},showInfo:function(a){var b=f.get("div.tdog-popup-talkright",c),d=1==m.appId;if(b)if(!d&&a.item&&a.item.id){var e=a.item,h='<div class="tdog-popup-goodsinfo"><p class="tdog-goodsinfo-head">\u5b9d\u8d1d\u63cf\u8ff0</p><div><div class="tdog-goodsinfo-pic"><p class="tdog-goodsinfo-img"><a href="http://item.taobao.com/item_detail-null-'+e.id+'.jhtml"  target = "_blank"><img src="'+e.imageUrl+'_80x80.jpg" title="'+e.title+'"/></a></p></div>'+"</div>"+'<p class="tdog-goodsinfo-title"><a href="http://item.taobao.com/item_detail-null-'+e.id+'.jhtml"  target = "_blank">'+e.title+"</a></p>"+'<p class="tdog-goodsinfo-price">\u4e00\u53e3\u4ef7\uff1a<span>'+e.price+"</span>\u5143</p>"+'<p><a href="http://buy.taobao.com/auction/buy_now.jhtml?auction_id='+e.id+'" title="\u7acb\u523b\u8d2d\u4e70" class="tdog-goodsinfo-linkbuy" target = "_blank"></a></p>'+"</div>";g.css(b,"background-image","none"),b.innerHTML=h}else if(a.user&&a.user.nick){var i={nick:"",sex:"\u4fdd\u5bc6",from:"\u4fdd\u5bc6",registDate:"",visitDate:"\u6ca1\u6709\u767b\u5f55",sellNum:"",buyNum:"",certification:"",relation:""};switch(i=f.merge(i,a.user),i.sex){case 1:i.sex="\u7537";break;case 2:i.sex="\u5973";break;default:i.sex="\u4fdd\u5bc6"}var j=i.sellNum,k=i.buyNum,l="true"==i.certification;0!=j&&(j='<img align="absmiddle" title="\u5356\u5bb6\u4fe1\u7528\u79ef\u5206" src="http://a.tbcdn.cn/sys/common/icon/rank/b_'+i.sellNum+'.gif" />'),0!=k&&(k='<img align="absmiddle" title="\u4e70\u5bb6\u4fe1\u7528\u79ef\u5206" src="http://a.tbcdn.cn/sys/common/icon/rank/c_'+i.buyNum+'.gif" />'),l&&(l='<img align="absmiddle" title="\u6dd8\u5b9d\u8ba4\u8bc1\u5546\u6237" src="http://a.tbcdn.cn/sys/common/icon/trade/mall_auth.png" />');var n="";3==a.user.suspended&&(n='<p class="tdog-userinfo-suspended">\u8be5\u7528\u6237\u5df2\u7ecf\u88ab\u67e5\u5c01</p>');var o='<div class="tdog-popup-userinfo">'+n+'<p class="tdog-userinfo-username">'+i.nick+"</p>"+'<p>\u6765\u81ea\uff1a<span class="tdog-popup-userinfo-from">'+i.from+"</span><br/> \u6027\u522b\uff1a"+i.sex+"</p>"+"<p>\u6ce8\u518c\u65f6\u95f4\uff1a"+i.registDate.split(" ")[0]+"</p>"+"<p>\u4e0a\u6b21\u767b\u5f55\uff1a"+i.visitDate.split(" ")[0]+"</p>"+(""!=j?"<p>\u5356\u5bb6\uff1a"+j+"</p>":"")+(""!=k?"<p>\u4e70\u5bb6\uff1a"+k+"</p>":"")+(l?"<p>\u8ba4\u8bc1\uff1a"+l+"</p>":"")+"</div>";g.css(b,"background-image","none"),b.innerHTML=o,i.relation=1==i.relation?"\u597d\u53cb":"\u964c\u751f\u4eba";var p=f.get("div.tdog-popup-head",c);b=f.get("div",p),b.innerHTML=b.innerHTML.replace(/\u964c\u751f\u4eba/,i.relation)}},checkDialogOpen:function(a){return e?l.formatNick(a)==l.formatNick(e.userName):void 0},isOpen:function(){return!!c},getTargetUser:function(){return e.userName},updateUserStatus:function(b,d){if(l.formatNick(e.userName)==l.formatNick(b)){var g,h=f.get("div.tdog-popup-head",c),i=f.get("div",h),j="",k=/\u597d\u53cb/;d=a.USER_STATUS[d],""!=d[1]&&(j=" - "+d[1]),g=k.test(i.innerHTML)?"(\u597d\u53cb)":"(\u964c\u751f\u4eba)",i.innerHTML='<i></i><div class="tdog-contact-info"><span class="tdog-popup-contact">'+e.userName+"</span>"+j+"</div>",i.className="tdog-status-"+d[0]}},showMsg:function(a){if(f.isArray(a)){for(var d=f.get("div.tdog-popup-talkhistory",c),e=(f.get("div.tdog-popup-talkcontainer",b),0),g="";e<a.length;e++)g+=this.__getMessageRealContent(a[e]);d.innerHTML+=g,f.later(function(){d.scrollTop=d.scrollHeight},200,!1)}},showSysTip:function(a,b){if(c){var d;b?(d=f.get("div.tdog-popup-talkright",c),d&&(g.css(d,"background-image","none"),d.innerHTML=a)):(d=f.get("div.tdog-popup-talkhistory",c),d&&(d.innerHTML+='<div class="tdog-talk-filetip"><i></i>'+a+"</div>",d.scrollTop=d.scrollHeight))}},updateMsg:function(){if(c){var b=f.get("div.tdog-popup-talkhistory",c),d=a.DataManager.getAllMessages(e.userId);
b.innerHTML="",a.ChatDialog.showMsg(d),k.fire(a.EVENTS.UPDATE_STATUS_ICON)}},getCurrentChatUserId:function(){return this.isOpen()?e&&e.userId?e.userId:"":""},getCurrentChatUserInfo:function(){return this.isOpen()?e:{}},clearCurrentChatUserId:function(){e&&e.userId&&(e.userId="")},sendMsg:function(b){var c=a.DataManager.getNickName(),d=a.Util.charToFace(b.value,!0);this.showMsg([{fromId:this.getCurrentChatUserId(),userId:c,sendTime:a.Util.formatDate(new Date),content:a.Util.escapeHTML(d),type:a.MESSAGE_TYPE.SELF}]),e.userId.length||a.Util.detect("ww.1.20.1.1.6",c);var f=l.formatNick(e.userId);k.fire(a.EVENTS.SEND_MESSAGE,{userName:f,content:d,callback:{onFailure:function(){a.ChatDialog.showSysTip("<p><span>\u7f51\u7edc\u539f\u56e0\uff0c\u6d88\u606f\u53d1\u9001\u5931\u8d25\uff01</span></p>")},onTimeout:function(){a.ChatDialog.showSysTip("<p><span>\u7f51\u7edc\u8d85\u65f6\uff01</span></p>")}}}),b.value=""},changeBut:function(){var a=f.get("div.tdog-popup-talkinput",c).getElementsByTagName("textarea")[0],b=f.get("span.tdog-popup-sendbut",c),d="tdog-popup-sendbut-off",e=a.value;""==e?g.hasClass(b,d)||g.addClass(b,d):""!=e&&g.hasClass(b,d)&&g.removeClass(b,d)},_bindUI:function(b){var i=f.get("span.tdog-popup-help",b),k=f.get("span.tdog-popup-close",b),m=f.get("a.tdog-popup-pulloff",b),q=f.get("div.tdog-popup-talkright",b),r=f.get("div.tdog-popup-talkleftinner",b),s=f.get("span.tdog-popup-changesend",b),t=f.get("div.tdog-popup-talkbar",b),u=f.get("span.tdog-popup-talkbar-clear",b),v=f.get("div.tdog-popup-talkhistory",b),w=(f.get("div.tdog-popup-tms-bullet",b),g.children(t)[0]),x=g.next(s),y=x.getElementsByTagName("li"),z=f.get("span.tdog-popup-send",b),A=f.get("div.tdog-popup-talkinput",b).getElementsByTagName("textarea")[0];h.on(b,"click",function(a){var c=a.target;if(c!=w&&g.css(d,"display","none"),"tdog-popup-tms-bulletin-close"==c.className){var e=v.offsetHeight+22;f.get("div.tdog-popup-tms-bulletin-close",b).parentNode.parentNode.style.display="none",g.css([v,m],"height",e)}}),h.on(i,"click",function(){var b=j(a.DataManager.getNickName()),c=j("\u95ee\u9898\u54a8\u8be2");p.open("http://im.robot.aliapp.com/all/aliqzg/webspace.jsp?id=4&userId="+b+"&ask="+c),a.Util.sendLog("wwweblog=checkww")}),h.on(u,"click",function(){var b=a.ChatDialog.getCurrentChatUserId();v.innerHTML="",a.DataManager.deleteMessage(b),l.clearChatMessage(b)}),h.on(k,"click",function(){b.style.display="none",g.css(d,"display","none"),v.innerHTML="",c=!1,e=""}),h.on(m,"click",function(){"none"!=q.style.display?(n.css([[q,"display","none"],[b,"width",v.offsetWidth+(f.UA.ie?6:2)+"px"],[r,"margin-right","auto"],[v,"width","auto"],[v,"marginRight","6px"]]),g.attr(m,"title","\u663e\u793a\u4fa7\u8fb9\u680f"),m.className="tdog-popup-pullon",f.get("div.tdog-popup-handle-y",b).style.height="38%"):(n.css([[q,"display","block"],[b,"width",b.offsetWidth+147+"px"],[r,"marginRight","145px"]]),q.style.height=parseInt(b.offsetHeight)-37+"px",g.attr(m,"title","\u9690\u85cf\u4fa7\u8fb9\u680f"),m.className="tdog-popup-pulloff",f.get("div.tdog-popup-handle-y",b).style.height="95%")}),h.on(z,"click",function(){a.ChatDialog.__checkLength(A.value)&&(this.sendMsg(A),this.changeBut(),g.css(x,"display","none"))},this,!0),h.on(s,"click",function(){"none"==g.css(x,"display")?(g.css(x,"display","block"),g.addClass(b,"tdog-popup-visible"),6==f.UA.ie&&g.css(b,"paddingBottom","0")):(g.css(x,"display","none"),g.hasClass(b,"tdog-popup-visible")&&(g.removeClass(b,"tdog-popup-visible"),6==f.UA.ie&&g.css(b,"paddingBottom","1px")))}),h.on(y[0],"click",function(){""==y[0].className&&(y[0].className="tdog-send-mode",y[1].className=""),g.css(x,"display","none")}),h.on(y[1],"click",function(){""==y[1].className&&(y[1].className="tdog-send-mode",y[0].className=""),g.css(x,"display","none")}),h.on(A,"mousedown",function(){this.changeBut()},this,!0),h.on(A,"paste",function(){var a=this;p.setTimeout(function(){a.changeBut()},100)},this,!0),h.on(A,"keyup",function(){this.changeBut()},this,!0),h.on(A,"keydown",function(b){var c=this;if(null!=b){if(b.ctrlKey&&13==b.keyCode){var d=A.value;if("tdog-send-mode"==y[0].className){if(!a.ChatDialog.__checkLength(d))return;this.sendMsg(A)}else if(o.selection){var e=o.selection.createRange();e.text="\r\n"}else{var f=d.length,g=f-A.selectionEnd;A.value=d.substr(0,A.selectionStart)+"\r\n"+d.substring(A.selectionEnd,f),A.selectionEnd=f-g+1}}else if(13==b.keyCode&&"tdog-send-mode"==y[1].className){if(b.preventDefault(),!a.ChatDialog.__checkLength(A.value))return;this.sendMsg(A)}27==b.keyCode&&c.closeDialog()}},this,!0),h.on(w,"click",function(){a.ChatDialog.Face.show(w,A)}),h.on(v,"click",function(a){var b=a.target;if("A"==b.nodeName.toUpperCase()&&"webww-msg-unsafe-link"==b.parentNode.className){var d,e=f.get("div.tdog-popup-talkhistory",c),i=f.get("div.tdog-popup-tips");i?(i.style.top=e.offsetHeight+e.scrollTop-150+"px",f.get("#__last__webww_msg_unsafe_link").href=b.href):(i='<div class="tdog-tips tdog-popup-tips"><div class="tdog-tipscontainer"><i class="tdog-tipsalert"></i><i class="tdog-tipsclose"></i><div class="tdog-tipsmain"><p>\u65e0\u6cd5\u786e\u8ba4\u94fe\u63a5\u7684\u5b89\u5168\u6027\uff0c\u8bf7\u53ea\u6253\u5f00\u6765\u6e90\u53ef\u9760\u7684\u7f51\u5740</p><p><a id="__last__webww_msg_unsafe_link" href="'+b.href+'" target="_blank">\u6253\u5f00\u94fe\u63a5</a>&nbsp;&nbsp;&nbsp;&nbsp;</p>'+"</div>"+"</div>"+"</div>",i=g.create(i),b.parentNode.appendChild(i),e.scrollHeight-150>0&&(i.style.top=e.offsetHeight+e.scrollTop-150+"px"),i.style.zoom=1,d=f.get("i.tdog-tipsclose",i),h.on(d,"click",function(){b.parentNode.removeChild(i)})),a.preventDefault()}})},__getMessageRealContent:function(b){var c=parseInt(b.type);switch("-"===b.userId&&(b.userId=a.DataManager.getNickName()),c){case a.MESSAGE_TYPE.SELF:return this.__talkMessage(b,b.userId,!0);case a.MESSAGE_TYPE.OFFLINE:return this.__talkMessage(b,b.fromId);case a.MESSAGE_TYPE.TALK:var d="",e=parseInt(b.subType);switch(e){case a.MESSAGE_SUBTYPE.FAIL_ACK:d=a.UNSUPPORT_MSG[e].replace("{content}",b.content);break;case a.MESSAGE_SUBTYPE.ILLEGALITY:d=b.content;break;case a.MESSAGE_SUBTYPE.NEED_AUTH:return"";case a.MESSAGE_SUBTYPE.FILE_MESSAGE:case a.MESSAGE_SUBTYPE.PIC_MESSAGE:case a.MESSAGE_SUBTYPE.GRAFFITI:case a.MESSAGE_SUBTYPE.REMOTE_ASSIST:case a.MESSAGE_SUBTYPE.AV:case a.MESSAGE_SUBTYPE.FOLDER:case a.MESSAGE_SUBTYPE.PEER_VERIFY:d=a.UNSUPPORT_MSG[e]+"</br>"+a.ERROR_MESSAGE["-40000"];break;case a.MESSAGE_SUBTYPE.TALK_MESSAGE:return this.__talkMessage(b,b.fromId,void 0,void 0,!0);case a.MESSAGE_SUBTYPE.AUTO_BACK_TALK_MESSAGE:return this.__talkMessage(b,b.fromId,void 0,!0,!0);default:return f.log("\u51fa\u73b0\u672a\u5b9a\u4e49\u7684\u6d88\u606f\u7c7b\u578b\uff1a"+b.subType,"warn"),""}return'<div class="tdog-talk-filetip"><i></i><p><span>'+d+"</span></p></div>"}return f.log("\u6d88\u606f\u4e2d\u51fa\u73b0\u9519\u8bef:"+c,"warn"),""},__talkMessage:function(b,c,d,e){var f=b.content,g=b.sendTime.length<=19?b.sendTime:b.sendTime.substring(0,19);return f=a.Util.charToFace(b.content,null,d),f=f.replace(/\n/g,"<br />"),'<p class="tdog-talk-others"><span class="tdog-talk-username">'+a.Util.getUserName(c)+'</span><span class="tdog-talk-time">('+g+"):</span></p>"+'<div class="tdog-talk-content">'+(e?'<span class="tdog-auto-back-talk-message">[\u81ea\u52a8\u56de\u590d]</span>':"")+f+"</div>"},__checkLength:function(a){var c,d,e='<div class="tdog-tips tdog-popup-tips"><div class="tdog-tipscontainer"><s class="tdog-tipsext"></s><i class="tdog-tipsimg"></i><i class="tdog-tipsclose"></i><div class="tdog-tipsmain"><p>\u4f60\u53d1\u9001\u7684\u6d88\u606f\u8fc7\u957f\uff0c\u8bf7\u4e0b\u8f7d\u652f\u6301\u53d1\u9001\u8d85\u957f\u4fe1\u606f\u7684<a href="'+m.downloadWangWangURLBuy+'" target="_blank">\u963f\u91cc\u65fa\u65fa\u5ba2\u6237\u7aef</a></p>'+"</div>"+"</div>"+"</div>",i=f.get("div.tdog-popup-talkcontainer",b);for(d=0,c=0;c<a.length;c++)d+=a.charCodeAt(c)>=0&&a.charCodeAt(c)<=255?1:2;if(d>300){if(1==f.query("div.tdog-popup-tips",i).length)return;var j,k=g.create(e);return i.appendChild(k),j=f.get("i.tdog-tipsclose",k),h.on(j,"click",function(){i.removeChild(k)}),!1}return 0==d?!1:!0}},a.ChatDialog.Face={init:function(){d=o.createElement("div"),d.id="tdog-face-container";for(var a=0;99>a;a++)d.innerHTML+='<span data-icon="'+a+'.gif"></span>';f.get("#tstart").appendChild(d),this._bindUI()},show:function(a,b){d?d.style.display="block":this.init(b);var c=[g.offset(a).left,g.offset(a).top-237];g.offset(d,{left:c[0],top:c[1]}),b.focus()},_bindUI:function(){h.on(d,"click",function(b){var e=f.get("div.tdog-popup-talkinput",c).getElementsByTagName("textarea")[0],h=b.target,i=g.attr(h,"data-icon");if(i=a.Util.faceToChar(i),e.focus(),"undefined"!=typeof o.selection)o.selection.createRange().text=i;else{var j=e.value,k=j.length,l=k-e.selectionEnd;e.value=j.substr(0,e.selectionStart)+i+j.substring(e.selectionEnd,e.value.length),e.selectionEnd=e.value.length-l}d.style.display="none",a.ChatDialog.changeBut()})}}}),TDog.add("StatusIcon",function(a){var b,c=KISSY,d=c.DOM,e=0;a.StatusIcon={init:function(){c.log("init StatusIcon"),b=c.get("#tstart-plugin-tdog s.tstart-item-icon"),this.offline()},onlogin:function(){b.className="tstart-item-icon tstart-tdog-login"},isLogining:function(){return d.hasClass(b,"tstart-tdog-login")},online:function(){"tstart-item-icon tstart-tdog-online"!=b.className&&(b.className="tstart-item-icon tstart-tdog-online")},offline:function(){b.className="tstart-item-icon tstart-tdog-offline"},isOffline:function(){return d.hasClass(b,"tstart-tdog-offline")},getmessage:function(){"tstart-item-icon tstart-tdog-mess"!=b.className&&(b.className="tstart-item-icon tstart-tdog-mess")},onNewMessage:function(){return d.hasClass(b,"tstart-tdog-mess")},showcount:function(a){e!==a&&(0==a?(b.innerHTML="",this.online()):(b.innerHTML='<span class="tdog-toolbar-msgnum">'+a+"</span>",this.getmessage()),e=a)},removeicon:function(){b.className="tstart-item-icon"}}}),TDog.add("SysMessage",function(a){var b,c,d,e=KISSY,f=e.DOM,g=e.Event,h="none",i="block",j='<div id="tdog-sys-message" class="tdog-simplepop" style="display:none;"><div class="tdog-simplepop-head"><span>\u7cfb\u7edf\u6d88\u606f</span><span class="tdog-closebut"></span></div><div class="tdog-simplepop-main"><div class="tdog-sysinfo"><dl></dl></div><div class="tdog-sysinfo-foot"></div></div></div>';a.SysMessage={init:function(){},_create:function(){b=f.create(j),e.get("#tstart").appendChild(b),c=e.get("dl",b),this._bindUI()},show:function(a){return a?(c||this._create(),this._loadData(a),b.style.display=i,void 0):!1},_loadData:function(a){a.datetime=a.datetime.split(" ")[0];var b=(a.content||"").replace(/\r\n/gi,"<br />");c.innerHTML='<dt><p><span class="tdog-info-mailicon"></span><span class="tdog-info-title">'+a.title+"</span>"+'<span class="tdog-info-time">'+a.datetime+"</span>"+'<span class="tdog-info-toolopen"></span>'+"</p>"+"</dt>"+'<dd style="display:none">'+b+"</dd>"+c.innerHTML},_bindUI:function(){g.on("#tdog-sys-message .tdog-closebut","click",function(){b.style.display=h}),g.on(c,"click",function(a){for(var b,f=a.target,g=f;"DT"!==g.nodeName&&g!==c;)g=g.parentNode;"DT"===g.nodeName&&(d&&d!=g&&e.get(".tdog-info-toolclose",d)&&(e.get(".tdog-info-toolclose",d).className="tdog-info-toolopen",d.nextSibling.style.display=h),b=g.nextSibling,b.style.display===i?(e.get(".tdog-info-toolclose",g).className="tdog-info-toolopen",b.style.display=h):(e.get(".tdog-info-toolopen",g).className="tdog-info-toolclose",b.style.display=i),d=g)})}}}),TDog.add("SysPopup",function(a){function b(a,b){return a.replace(/\{([^}]+)\}/g,function(a,c){return b[c]||""})}var c=KISSY,d=c.DOM,e=c.Event;POPUP_TEMP='<div class="tdog-simplepop" style="width:225px;"><div class="tdog-simplepop-head"><span class="tdog-simplepop-icon"></span><span>{title}</span><span class="tdog-closebut"></span> </div><div class="tdog-simplepop-main"><div class="tdog-remind"><div class="tdog-remind-inner">{content}</div></div> <div class="tdog-remind-foot"><span>{time}</span></div></div></div>',a.SysPopup={init:function(){},show:function(e){if(e.content){var f={title:"\u6dd8\u5b9d\u65fa\u65fa\u8ba2\u9605\u63d0\u9192",width:"225px",time:new Date,staytime:6e4};if(e.style){var g=c.unparam(e.style,";");f=Y.lang.merge(f,g)}e.time&&(f.time=e.time),f.content=e.content,f.time=a.Util.formatDate(f.time);var h=d.create(b(POPUP_TEMP,f));c.get("#tstart").appendChild(h),this._bindUI(h),window.setTimeout(function(){h&&c.get("#tstart").removeChild(h)},f.staytime)}},_bindUI:function(a){var b=c.get("span.tdog-closebut",a);e.on(b,"click",function(){c.get("#tstart").removeChild(a)})}}}),TDog.add("SysTips",function(a){var b,c,d,e=KISSY,f=e.DOM,g=e.Event,h="tstart-item-hover-tips",i="tstart-hidden",j="tstart-tips-login-ok-btn",k="tstart-client-oneline",l="tstart-client-cancle-oneline",m="tstart-client-help-oneline",n='<span class="tstart-item-tips tdog-systips tstart-hidden"><i></i><s></s><div class="tdog-systips-content">{CONTENT}</div></span>';a.SysTips={init:function(){e.log("init SysTips");var g=a.hostEl;c=f.create(n),d=e.get(".tdog-systips-content",c),g.appendChild(c),b=e.get(".tstart-tdog-trigger",g),this._bindUI()},show:function(b,g,j){c.style.width=(g||120)+"px",d.innerHTML=b||a.ERROR_MESSAGE[-1],f.removeClass(c,h),f.removeClass(c,i),j&&e.later("hide",1e3*j,!1,this,c)},setHoverTips:function(a){d.innerHTML=a,f.addClass(c,h)},hide:function(){f.addClass(c,i)},_bindUI:function(){var b=this;g.on(c,"click",function(c){var d=c.target;f.hasClass(d,j)?a.WebServer.login():f.hasClass(d,k)?(a.Login.online=!0,a.Login.ready=!0,a.WebServer.login(a.WebServer.AUTO_LOGIN.forcedLogin),a.Util.sendLog("&wwweblog=confirm")):f.hasClass(d,m)?window.open("http://im.robot.aliapp.com/all/aliqzg/webspace.jsp?id=4&ask=%E5%AE%89%E8%A3%85%E4%BA%86%E9%98%BF%E9%87%8C%E6%97%BA%E6%97%BA%EF%BC%8C%E7%82%B9%E2%80%9C%E5%92%8C%E6%88%91%E8%81%94%E7%B3%BB%E2%80%9D%E6%9C%AA%E5%BC%B9%E5%87%BA%E8%81%8A%E5%A4%A9%E7%AA%97%E5%8F%A3%EF%BC%9F&page=kjts",""):f.hasClass(d,l)?(a.StatusIcon.offline(),a.Util.sendLog("&wwweblog=cancel")):"A"===d.nodeName&&"tstart-item-tips-on"!=d.className&&(location.href=d.href),b.hide()})},showLoginTips:function(b){if(b||a.StatusIcon.isLogining())this.show("\u963f\u91cc\u65fa\u65fa\u6b63\u5728\u767b\u5f55\uff0c\u8bf7\u7a0d\u5019\u2026\u2026",110);else{var c=a.DataManager.getNickName();this.show("\u548c\u5bf9\u65b9\u804a\u5929\uff0c\u9700\u8981\u767b\u5f55\u963f\u91cc\u65fa\u65fa\uff0c\u786e\u5b9a\u7528\u5e10\u53f7\uff08"+c+'\uff09\u767b\u5f55\u5417\uff1f<hr><span class="tstart-item-tips-btn '+j+'">\u786e\u5b9a</span><span class="tstart-item-tips-btn">\u53d6\u6d88</span>',200)}},showClientOnlineTips:function(){var b=a.DataManager.getNickName(),c="http://service.taobao.com/support/help-16380.htm";this.show("\u60a8\u7684\u5e10\u53f7\uff08"+b+'\uff09\u5df2\u7ecf\u767b\u5f55\u4e86\u963f\u91cc\u65fa\u65fa<br/>1\u3001\u70b9\u51fb\u3010\u786e\u5b9a\u3011\u7ee7\u7eed\u767b\u5f55\u7f51\u9875\u7248,\u767b\u5f55\u6210\u529f\u540e\u4f1a\u628a\u5df2\u767b\u5f55\u7684\u5ba2\u6237\u7aef\u8e22\u4e0b\u7ebf<br>2\u3001\u5982\u679c\u60a8\u5df2\u767b\u5f55\u5ba2\u6237\u7aef,\u70b9\u51fb\u3010<a target="_blank" class="tstart-item-tips-on" href='+c+' >\u5e2e\u52a9</a>\u3011,\u83b7\u53d6\u5982\u4f55\u7ee7\u7eed\u4f7f\u7528(\u4fee\u590d)\u5ba2\u6237\u7aef\u7684\u65b9\u6cd5<hr><span class="tstart-item-tips-btn '+k+'">\u786e\u5b9a</span><span class="tstart-item-tips-btn '+l+'">\u53d6\u6d88</span><span class="tstart-item-tips-btn '+m+'">\u5e2e\u52a9</span>',280)},showLoginFailedTips:function(b){var c=a.ERROR_MESSAGE[b]||"\u963f\u91cc\u65fa\u65fa\u6682\u65f6\u4e0d\u53ef\u7528\uff0c\u8bf7\u7a0d\u5019\u518d\u8bd5";this.show(c+'<hr><span class="tstart-item-tips-btn">\u786e\u5b9a</span>',180)},showLogoutTips:function(b){b=b||-1;var c="\u963f\u91cc\u65fa\u65fa\u73b0\u5728\u79bb\u7ebf\u4e86\u3002<hr>\u662f\u5426\u91cd\u65b0\u767b\u5f55\uff1f";"402"==b&&(c="\u4f60\u7684\u5e10\u53f7("+a.DataManager.getNickName()+")\u5df2\u7ecf\u5728\u5176\u4ed6\u5730\u65b9\u767b\u5f55\uff01<hr>\u9700\u8981\u91cd\u65b0\u767b\u5f55\u5417\uff1f"),-1!=b&&this.show(c+'<br /><span class="tstart-item-tips-btn '+j+'">\u786e\u5b9a</span><span class="tstart-item-tips-btn">\u53d6\u6d88</span>',180)},showWelcomeTips:function(){this.show("\u6b22\u8fce\u4f7f\u7528\u5168\u65b0\u963f\u91cc\u65fa\u65fa\u7f51\u9875\u7248\uff01",100)},showLastTips:function(){f.hasClass(c,h)||f.removeClass(c,i)}}}),TStart.add("plugin~tdog",function(a){var b=KISSY.DOM,c=KISSY.Event,d=(a.PLUGIN_TYPE,TDog.EVENTS),e=TDog.EventCenter,f='<div class="tstart-tdog-panel"><div class="tstart-tdog-panel-hd"><span>\u6700\u8fd1\u8054\u7cfb\u4eba</span><s class="tstart-tdog-panel-closebtn"><img src="http://img01.taobaocdn.com/tps/i1/T1R6pOXoRyXXXXXXXX-15-15.png"></s></div><div class="tstart-tdog-panel-bd tstart-panel-loading" style="width:160px;height:160px"></div></div>';a.addPlugin("tdog",{type:"custom",tips:"\u963f\u91cc\u65fa\u65fa",html:'<span class="tstart-tdog-trigger"><s class="tstart-item-icon"></s></span>'+f,init:function(){function f(a){return b.hasClass(a.target,"tstart-item-icon")?e.fire(d.CLICK_STATUS_ICON):!1}function g(){TDog.DataManager.isLogin()&&(TDog.WebServer.getTalkUsers(),b.removeClass(b.get(".tstart-tdog-panel-bd","#tstart-plugin-tdog"),"tstart-panel-loading"))}c.on("#tstart-plugin-tdog","click",function(c){var d,e=c.target;b.hasClass(e,"tstart-item-icon")&&(d=b.parent(e,".tstart-item"),b.hasClass(d,"tstart-item-active")?b.removeClass(d,"tstart-item-active"):f(c)&&(a.fire("closePanel"),b.addClass(d,"tstart-item-active"),g(c)))}),TDog.init(a,b.get("#tstart-plugin-tdog")),a.sendStatistic("1002.1.1")}})}),TStart.add("plugin~settings",function(a){var b=KISSY,c=b.DOM,d=b.Event,e=(a.PLUGIN_TYPE,"tstart-item-active");a.Config.isOnline?"taobao.com":"daily.taobao.net",a.addPlugin("settings",{type:"custom",html:'<span class="tstart-settings-trigger" title="\u8bbe\u7f6e web \u65fa\u65fa"><s></s></span><div class="tstart-settings-panel"><div class="tstart-settings-panel-hd"></div><div class="tstart-settings-panel-bd"><p><input type="checkbox" class="tstart-settings-login"/><label>\u81ea\u52a8\u767b\u5f55</label></p><p><input type="checkbox" class="tstart-settings-msg"/><label>\u63a5\u53d7\u964c\u751f\u4eba\u6d88\u606f</label></p></div></div>',init:function(){var a=c.get("#tstart-plugin-settings"),b=c.get(".tstart-settings-panel",a),f=c.get(".tstart-settings-login",a),g=c.get("#tstart-plugin-tdog"),h=c.get(".tstart-settings-msg",a);d.on(a,"click",function(b){c.hasClass(a,e)||TDog.WebServer.checkUserSeting(),c.hasClass(g,e)&&c.removeClass(g,e),TStart.fire("closePanel"),c.toggleClass(a,e),b.stopPropagation()}),d.on(b,"click",function(a){a.stopPropagation()}),d.on(document,"click",function(){c.removeClass(a,e)}),d.on(f,"click",function(){var a=-1;a=f.checked?2:1,TDog.WebServer.setAutoLogin(a)}),d.on(h,"click",function(){var a=-1;a=h.checked?3:4,TDog.WebServer.setStrangerMsg(a)})}})}),TStart.initPlugins();